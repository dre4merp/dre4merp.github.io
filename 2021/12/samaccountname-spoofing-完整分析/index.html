<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>sAMAccountName spoofing 完整分析 - dre4merp's blog</title><meta name=Description content="This is dre4merp's blog."><meta property="og:title" content="sAMAccountName spoofing 完整分析">
<meta property="og:description" content="背景漏洞编号为：CVE-2021-42278 和 CVE-2021-42287 CVE-2021-42278：通常情况下，机器账户应以$结尾，即DC$。 但是AD域并没有对其"><meta property="og:type" content="article"><meta property="og:url" content="http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/"><meta property="og:image" content="http://dre4merp.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-30T23:21:55+08:00"><meta property="article:modified_time" content="2021-12-30T23:21:55+08:00"><meta property="og:site_name" content="dre4merp's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://dre4merp.github.io/logo.png"><meta name=twitter:title content="sAMAccountName spoofing 完整分析"><meta name=twitter:description content="背景漏洞编号为：CVE-2021-42278 和 CVE-2021-42287 CVE-2021-42278：通常情况下，机器账户应以$结尾，即DC$。 但是AD域并没有对其"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/><link rel=prev href=http://dre4merp.github.io/2021/12/kerberos-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/><link rel=next href=http://dre4merp.github.io/2021/12/printnightmare-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"sAMAccountName spoofing 完整分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/dre4merp.github.io\/2021\/12\/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90\/"},"genre":"posts","wordcount":6216,"url":"http:\/\/dre4merp.github.io\/2021\/12\/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90\/","datePublished":"2021-12-30T23:21:55+08:00","dateModified":"2021-12-30T23:21:55+08:00","publisher":{"@type":"Organization","name":""},"authors":[{"@type":"Person","name":"dre4merp"}],"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"dark"==="light"||"dark"==="dark"||"dark"==="black"?(setTheme("dark"),saveTheme("dark")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>归档 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于我 </a><a class=menu-item href=/index.xml>订阅 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>归档</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于我</a><a class=menu-item href=/index.xml title>订阅</a><a href=javascript:void(0); class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#环境配置>环境配置</a></li><li><a href=#详细分析>详细分析</a><ul><li><a href=#active-directory-目录树>Active Directory 目录树</a></li><li><a href=#攻击准备工作>攻击准备工作</a></li><li><a href=#申请tgt>申请TGT</a></li><li><a href=#还原机器账户名>还原机器账户名</a></li><li><a href=#申请st>申请ST</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">sAMAccountName spoofing 完整分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class="author fas fa-user-circle fa-fw"></span><span class=screen-reader-text> </span><a href=http://dre4merp.github.io/authors/dre4merp>dre4merp</a></span></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-12-30>2021-12-30</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2021-12-30>2021-12-30</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6216 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#环境配置>环境配置</a></li><li><a href=#详细分析>详细分析</a><ul><li><a href=#active-directory-目录树>Active Directory 目录树</a></li><li><a href=#攻击准备工作>攻击准备工作</a></li><li><a href=#申请tgt>申请TGT</a></li><li><a href=#还原机器账户名>还原机器账户名</a></li><li><a href=#申请st>申请ST</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><h2 id=背景 class=headerLink><a href=#%e8%83%8c%e6%99%af class=header-mark></a>背景</h2><p>漏洞编号为：<code>CVE-2021-42278</code> 和 <code>CVE-2021-42287</code></p><p>CVE-2021-42278：通常情况下，机器账户应以$结尾，即<code>DC$</code>。
但是AD域并没有对其进行强校验。通过建立与域控同名却不以$结尾的机器账户，即<code>DC</code>，对域控进行欺骗。</p><ul><li><a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42278 target=_blank rel="noopener noreferrer">MSRC CVE-2021-42278</a></li><li><a href=https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e target=_blank rel="noopener noreferrer">KB5008102 CVE-2021-42278</a></li></ul><p>CVE-2021-42287：利用上述漏洞进行欺骗，请求到DC的TGT后，修改自身的机器账号。之后，利用Kerberos的S4U2Self机制，请求对于“自己”（<code>DC</code>）的ST，但是由于此时机器名已经被修改而无法找到<code>DC</code>，域控将会用<code>DC$</code>的Key进行加密，并向其中添加请求的账户名的PAC。至此便得到了高权限ST。</p><ul><li><a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287 target=_blank rel="noopener noreferrer">MSRC CVE-2021-42287</a></li><li><a href=https://support.microsoft.com/en-gb/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-e0d0-4cb8-959a-143bd0201041 target=_blank rel="noopener noreferrer">KB5008102 CVE-2021-42287</a></li></ul><h2 id=环境配置 class=headerLink><a href=#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae class=header-mark></a>环境配置</h2><p>域控：Windows Server 2003 Debug版<br>攻击机：Windows 7 x64 SP1<br>武器化工具：<a href=https://github.com/cube0x0/noPac target=_blank rel="noopener noreferrer">https://github.com/cube0x0/noPac</a></p><h2 id=详细分析 class=headerLink><a href=#%e8%af%a6%e7%bb%86%e5%88%86%e6%9e%90 class=header-mark></a>详细分析</h2><h3 id=active-directory-目录树 class=headerLink><a href=#active-directory-%e7%9b%ae%e5%bd%95%e6%a0%91 class=header-mark></a>Active Directory 目录树</h3><p>使用SysinternalsSuite中的ADExplorer64工具查看域内的所有机器账户</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/ADExplorer.png title=ADExplorer data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/ADExplorer.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/ADExplorer.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/ADExplorer.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/ADExplorer.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/ADExplorer.png 2x" sizes=auto alt=ADExplorer></a></figure></p><p><del>上图显示了Active Directory中的完整目录树，其中需要注意的是Computers和Domain Controllers这两项在目录树中的相对位置，正是由于Computer在前，在遍历目录树时才会先获得新建的DC同名账户。</del><br>从上图中可以很明确的看到域控的机器名为<code>WINSRVSERVER$</code>，之后会使用<code>WINSRVSERVER</code>作为机器账户名进行欺骗。</p><h3 id=攻击准备工作 class=headerLink><a href=#%e6%94%bb%e5%87%bb%e5%87%86%e5%a4%87%e5%b7%a5%e4%bd%9c class=header-mark></a>攻击准备工作</h3><p>相关准备工作不是本文重点，可以在noPac项目中学习</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=c1>//new machine account</span>
</span></span><span class=line><span class=cl><span class=n>NewMachineAccount</span><span class=p>(</span><span class=n>argContainer</span><span class=p>,</span> <span class=n>argDistinguishedName</span><span class=p>,</span> <span class=n>argDomain</span><span class=p>,</span> <span class=n>argDomainController</span><span class=p>,</span> <span class=n>argMachineAccount</span><span class=p>,</span> <span class=n>argMachinePassword</span><span class=p>,</span> <span class=n>argVerbose</span><span class=p>,</span> <span class=n>argRandom</span><span class=p>,</span> <span class=n>credential</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//clean spn</span>
</span></span><span class=line><span class=cl><span class=n>SetMachineAccountAttribute</span><span class=p>(</span><span class=n>argContainer</span><span class=p>,</span> <span class=n>argDistinguishedName</span><span class=p>,</span> <span class=n>argDomain</span><span class=p>,</span> <span class=n>argDomainController</span><span class=p>,</span> <span class=s>&#34;serviceprincipalname&#34;</span><span class=p>,</span> <span class=n>argMachineAccount</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=n>argVerbose</span><span class=p>,</span> <span class=n>credential</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>//set samaccountname</span>
</span></span><span class=line><span class=cl><span class=n>SetMachineAccountAttribute</span><span class=p>(</span><span class=n>argContainer</span><span class=p>,</span> <span class=n>argDistinguishedName</span><span class=p>,</span> <span class=n>argDomain</span><span class=p>,</span> <span class=n>argDomainController</span><span class=p>,</span> <span class=s>&#34;samaccountname&#34;</span><span class=p>,</span> <span class=n>argMachineAccount</span><span class=p>,</span> <span class=n>argDomainController</span><span class=p>.</span><span class=n>Split</span><span class=p>(</span><span class=sc>&#39;.&#39;</span><span class=p>)[</span><span class=m>0</span><span class=p>],</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=n>argVerbose</span><span class=p>,</span> <span class=n>credential</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=申请tgt class=headerLink><a href=#%e7%94%b3%e8%af%b7tgt class=header-mark></a>申请TGT</h3><p>申请TGT时是根据修改后的机器账号<code>WINSRVSERVER</code>进行申请的。<br>域控调用<code>I_GetASTicket</code>处理<code>AS_REQ</code>消息<br>首先会调用<code>KdcNormalize</code>获得账户的相关信息包括<code>UserInfo</code>、<code>ClientTicketInfo</code>等<br>！！！请谨记这个函数，之后的漏洞利用过程会展开分析！！！</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KdcNormalize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>ClientName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>RequestRealm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=nb>NULL</span><span class=p>,</span>           <span class=c1>// no source ticket
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>NameFlags</span> <span class=o>|</span> <span class=n>KDC_NAME_CLIENT</span> <span class=o>|</span> <span class=n>KDC_NAME_FOLLOW_REFERRALS</span> <span class=o>|</span> <span class=n>KDC_NAME_CHECK_GC</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>FALSE</span><span class=p>,</span>          <span class=c1>// do not restrict user accounts (user2user)
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=o>&amp;</span><span class=n>ClientReferral</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>ClientRealm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;</span><span class=n>ClientTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>pExtendedError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;</span><span class=n>UserHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>WhichFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=mi>0L</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;</span><span class=n>UserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=o>&amp;</span><span class=n>GroupMembership</span>
</span></span><span class=line><span class=cl>                <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>通过上面获得的<code>ClientTicketInfo</code>调用<code>BuildTicketAS</code>生成TGT，堆栈如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; kc
</span></span><span class=line><span class=cl># 
</span></span><span class=line><span class=cl>00 KDCSVC!BuildTicketAS
</span></span><span class=line><span class=cl>01 KDCSVC!I_GetASTicket
</span></span><span class=line><span class=cl>02 KDCSVC!KdcGetTicket
</span></span><span class=line><span class=cl>03 KDCSVC!KdcAtqIoCompletion
</span></span><span class=line><span class=cl>04 NTDSATQ!ATQ_CONTEXT::IOCompletion
</span></span><span class=line><span class=cl>05 NTDSATQ!AtqpProcessContext
</span></span><span class=line><span class=cl>06 NTDSATQ!AtqPoolThread
</span></span><span class=line><span class=cl>07 kernel32!BaseThreadStart
</span></span></code></pre></td></tr></table></div></div><p>查看参数ClientTicketInfo和ClientName可以看到此次是以<code>WINSRVSERVER</code>的身份去申请TGT。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt ClientTicketInfo
</span></span><span class=line><span class=cl>Local var @ 0x332fa00 Type _KDC_TICKET_INFO*
</span></span><span class=line><span class=cl>0x0332fcb4 
</span></span><span class=line><span class=cl>   +0x000 AccountName      : _UNICODE_STRING &#34;WINSRVSERVER&#34;
</span></span><span class=line><span class=cl>   +0x008 TrustedForest    : _UNICODE_STRING &#34;&#34;
</span></span><span class=line><span class=cl>   +0x010 PasswordExpires  : _LARGE_INTEGER 0x7fffffff`ffffffff
</span></span><span class=line><span class=cl>   +0x018 fTicketOpts      : 0x7b
</span></span><span class=line><span class=cl>   +0x01c UserAccountControl : 0x80
</span></span><span class=line><span class=cl>   +0x020 UserId           : 0x472
</span></span><span class=line><span class=cl>   +0x024 TrustType        : 0
</span></span><span class=line><span class=cl>   +0x028 TrustAttributes  : 0
</span></span><span class=line><span class=cl>   +0x02c Passwords        : 0x0015eab8 _KERB_STORED_CREDENTIAL
</span></span><span class=line><span class=cl>   +0x030 OldPasswords     : 0x001522d0 _KERB_STORED_CREDENTIAL
</span></span><span class=line><span class=cl>   +0x034 TrustSid         : (null) 
</span></span><span class=line><span class=cl>   +0x038 PasswordVersion  : 1
</span></span><span class=line><span class=cl>   +0x03c LockoutThreshold : 0
</span></span><span class=line><span class=cl>kd&gt; dt ClientName
</span></span><span class=line><span class=cl>Local var @ 0x332fa04 Type KERB_PRINCIPAL_NAME*
</span></span><span class=line><span class=cl>0x00084c44 
</span></span><span class=line><span class=cl>   +0x000 name_type        : 0n1
</span></span><span class=line><span class=cl>   +0x004 name_string      : 0x000c3360 KERB_PRINCIPAL_NAME_name_string_s
</span></span><span class=line><span class=cl>kd&gt; dx -id 0,0,89c47a68 -r1 ((KDCSVC!KERB_PRINCIPAL_NAME_name_string_s *)0xc3360)
</span></span><span class=line><span class=cl>((KDCSVC!KERB_PRINCIPAL_NAME_name_string_s *)0xc3360)                 : 0xc3360 [Type: KERB_PRINCIPAL_NAME_name_string_s *]
</span></span><span class=line><span class=cl>    [+0x000] next             : 0x0 [Type: KERB_PRINCIPAL_NAME_name_string_s *]
</span></span><span class=line><span class=cl>    [+0x004] value            : 0xb45d8 : &#34;WINSRVSERVER&#34; [Type: char *]
</span></span></code></pre></td></tr></table></div></div><p>上述函数工作完成后，查看生成的Ticket，即<code>TGT</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt KERB_ENCRYPTED_TICKET 0x332fabc
</span></span><span class=line><span class=cl>KDCSVC!KERB_ENCRYPTED_TICKET
</span></span><span class=line><span class=cl>   +0x000 bit_mask         : 0xc0
</span></span><span class=line><span class=cl>   +0x000 o                : [1]  &#34;???&#34;
</span></span><span class=line><span class=cl>   +0x004 flags            : tagASN1bitstring_t
</span></span><span class=line><span class=cl>   +0x00c key              : KERB_ENCRYPTION_KEY
</span></span><span class=line><span class=cl>   +0x018 client_realm     : 0x000c5098  &#34;RENPENGYU03.COM&#34;
</span></span><span class=line><span class=cl>   +0x01c client_name      : KERB_PRINCIPAL_NAME
</span></span><span class=line><span class=cl>   +0x024 transited        : KERB_TRANSITED_ENCODING
</span></span><span class=line><span class=cl>   +0x030 authtime         : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x03e starttime        : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x04c endtime          : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x05a renew_until      : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x068 client_addresses : (null) 
</span></span><span class=line><span class=cl>   +0x06c authorization_data : (null) 
</span></span></code></pre></td></tr></table></div></div><p>此时还没有向其中添加PAC，会通过之前获得的<code>UserInfo</code>调用<code>KdcGetPacAuthData</code>生成所需的PAC<br>此时的PAC为<code>WINSRVSERVER</code>的PAC，属于正常流程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt AuthorizationData
</span></span><span class=line><span class=cl>Local var @ 0x332f9d0 Type PKERB_AUTHORIZATION_DATA_s
</span></span><span class=line><span class=cl>   +0x000 next             : (null) 
</span></span><span class=line><span class=cl>   +0x004 value            : PKERB_AUTHORIZATION_DATA_Seq
</span></span><span class=line><span class=cl>kd&gt; dx -id 0,0,89c47a68 -r1 (*((KDCSVC!PKERB_AUTHORIZATION_DATA_Seq *)0x332f9d4))
</span></span><span class=line><span class=cl>(*((KDCSVC!PKERB_AUTHORIZATION_DATA_Seq *)0x332f9d4))                 [Type: PKERB_AUTHORIZATION_DATA_Seq]
</span></span><span class=line><span class=cl>    [+0x000] auth_data_type   : 128 [Type: long]
</span></span><span class=line><span class=cl>    [+0x004] auth_data        [Type: tagASN1octetstring_t]
</span></span><span class=line><span class=cl>kd&gt; dx -id 0,0,89c47a68 -r1 (*((KDCSVC!tagASN1octetstring_t *)0x332f9d8))
</span></span><span class=line><span class=cl>(*((KDCSVC!tagASN1octetstring_t *)0x332f9d8))                 [Type: tagASN1octetstring_t]
</span></span><span class=line><span class=cl>    [+0x000] length           : 0x260 [Type: unsigned long]
</span></span><span class=line><span class=cl>    [+0x004] value            : 0x16c828 : 0x4 [Type: unsigned char *]
</span></span><span class=line><span class=cl>kd&gt; db 0x16c828 l 260
</span></span><span class=line><span class=cl>0016c828  04 00 00 00 00 00 00 00-01 00 00 00 c0 01 00 00  ................
</span></span><span class=line><span class=cl>0016c838  48 00 00 00 00 00 00 00-0a 00 00 00 22 00 00 00  H...........&#34;...
</span></span><span class=line><span class=cl>0016c848  08 02 00 00 00 00 00 00-06 00 00 00 14 00 00 00  ................
</span></span><span class=line><span class=cl>0016c858  30 02 00 00 00 00 00 00-07 00 00 00 14 00 00 00  0...............
</span></span><span class=line><span class=cl>0016c868  48 02 00 00 00 00 00 00-01 10 08 00 cc cc cc cc  H...............
</span></span><span class=line><span class=cl>0016c878  b0 01 00 00 00 00 00 00-00 00 02 00 c2 dd c3 d9  ................
</span></span><span class=line><span class=cl>0016c888  0f f7 d7 01 ff ff ff ff-ff ff ff 7f ff ff ff ff  ................
</span></span><span class=line><span class=cl>0016c898  ff ff ff 7f 56 b9 d8 d7-0f f7 d7 01 56 79 42 02  ....V.......VyB.
</span></span><span class=line><span class=cl>0016c8a8  d9 f7 d7 01 ff ff ff ff-ff ff ff 7f 18 00 18 00  ................
</span></span><span class=line><span class=cl>0016c8b8  04 00 02 00 00 00 00 00-08 00 02 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c8c8  0c 00 02 00 00 00 00 00-10 00 02 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c8d8  14 00 02 00 00 00 00 00-18 00 02 00 01 00 00 00  ................
</span></span><span class=line><span class=cl>0016c8e8  72 04 00 00 03 02 00 00-01 00 00 00 1c 00 02 00  r...............
</span></span><span class=line><span class=cl>0016c8f8  20 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ...............
</span></span><span class=line><span class=cl>0016c908  00 00 00 00 18 00 1a 00-20 00 02 00 16 00 18 00  ........ .......
</span></span><span class=line><span class=cl>0016c918  24 00 02 00 28 00 02 00-00 00 00 00 00 00 00 00  $...(...........
</span></span><span class=line><span class=cl>0016c928  80 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c938  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c948  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c958  00 00 00 00 0c 00 00 00-00 00 00 00 0c 00 00 00  ................
</span></span><span class=line><span class=cl>0016c968  57 00 49 00 4e 00 53 00-52 00 56 00 53 00 45 00  W.I.N.S.R.V.S.E.
</span></span><span class=line><span class=cl>0016c978  52 00 56 00 45 00 52 00-00 00 00 00 00 00 00 00  R.V.E.R.........
</span></span><span class=line><span class=cl>0016c988  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c998  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c9a8  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0016c9b8  00 00 00 00 01 00 00 00-03 02 00 00 07 00 00 00  ................
</span></span><span class=line><span class=cl>0016c9c8  0d 00 00 00 00 00 00 00-0c 00 00 00 57 00 49 00  ............W.I.
</span></span><span class=line><span class=cl>0016c9d8  4e 00 53 00 52 00 56 00-53 00 45 00 52 00 56 00  N.S.R.V.S.E.R.V.
</span></span><span class=line><span class=cl>0016c9e8  45 00 52 00 0c 00 00 00-00 00 00 00 0b 00 00 00  E.R.............
</span></span><span class=line><span class=cl>0016c9f8  52 00 45 00 4e 00 50 00-45 00 4e 00 47 00 59 00  R.E.N.P.E.N.G.Y.
</span></span><span class=line><span class=cl>0016ca08  55 00 30 00 33 00 00 00-04 00 00 00 01 04 00 00  U.0.3...........
</span></span><span class=line><span class=cl>0016ca18  00 00 00 05 15 00 00 00-db ac e2 f8 a5 b2 f3 d1  ................
</span></span><span class=line><span class=cl>0016ca28  a1 c4 3e 10 00 00 00 00-00 b4 a3 e5 0f f7 d7 01  ..&gt;.............
</span></span><span class=line><span class=cl>0016ca38  18 00 57 00 49 00 4e 00-53 00 52 00 56 00 53 00  ..W.I.N.S.R.V.S.
</span></span><span class=line><span class=cl>0016ca48  45 00 52 00 56 00 45 00-52 00 00 00 00 00 00 00  E.R.V.E.R.......
</span></span><span class=line><span class=cl>0016ca58  76 ff ff ff c1 fc e6 ad-46 30 3f 05 5e ed 74 c0  v.......F0?.^.t.
</span></span><span class=line><span class=cl>0016ca68  20 7d c9 54 00 00 00 00-76 ff ff ff 42 e1 22 e3   }.T....v...B.&#34;.
</span></span><span class=line><span class=cl>0016ca78  3b 44 cd ee b7 d7 50 5f-2d f9 44 ab 00 00 00 00  ;D....P_-.D.....
</span></span></code></pre></td></tr></table></div></div><p>之后便是将PAC放入TGT中，将其打包并使用<code>krbtgt</code>密钥进行加密，通过<code>AS_REP</code>消息传递回Client<br>关键代码如下，不再展开分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>BuildReply</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>ClientTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>Nonce</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>?</span> <span class=nl>Nonce</span> <span class=p>:</span> <span class=n>RequestBody</span><span class=o>-&gt;</span><span class=n>nonce</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>Ticket</span><span class=p>.</span><span class=n>server_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Ticket</span><span class=p>.</span><span class=n>realm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>((</span><span class=n>RequestBody</span><span class=o>-&gt;</span><span class=n>bit_mask</span> <span class=o>&amp;</span> <span class=n>addresses_present</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=o>?</span> <span class=n>RequestBody</span><span class=o>-&gt;</span><span class=nl>addresses</span> <span class=p>:</span> <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>Ticket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>ReplyBody</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>  
</span></span><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KerbPackTicket</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>Ticket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ServerKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ServiceTicketInfo</span><span class=p>.</span><span class=n>PasswordVersion</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>Reply</span><span class=p>.</span><span class=n>ticket</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KerbPackKdcReplyBody</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=n>ReplyBody</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>EncryptionKey</span><span class=p>.</span><span class=n>keyvalue</span><span class=p>.</span><span class=n>value</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>?</span> <span class=o>&amp;</span><span class=nl>EncryptionKey</span> <span class=p>:</span> <span class=n>ClientKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>EncryptionKey</span><span class=p>.</span><span class=n>keyvalue</span><span class=p>.</span><span class=n>value</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>?</span> <span class=nl>KERB_NO_KEY_VERSION</span> <span class=p>:</span> <span class=n>ClientTicketInfo</span><span class=p>.</span><span class=n>PasswordVersion</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>KERB_TGS_REP_SALT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>KERB_ENCRYPTED_AS_REPLY_PDU</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;</span><span class=n>Reply</span><span class=p>.</span><span class=n>encrypted_part</span>
</span></span><span class=line><span class=cl>        <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=还原机器账户名 class=headerLink><a href=#%e8%bf%98%e5%8e%9f%e6%9c%ba%e5%99%a8%e8%b4%a6%e6%88%b7%e5%90%8d class=header-mark></a>还原机器账户名</h3><p>还原机器账户名的目的是使得域控处理<code>TGS_REQ</code>请求的时候，找不到账户从而是用自己的Key加密</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c# data-lang=c#><span class=line><span class=cl><span class=c1>//undo samaccountname change</span>
</span></span><span class=line><span class=cl><span class=n>SetMachineAccountAttribute</span><span class=p>(</span><span class=n>argContainer</span><span class=p>,</span> <span class=n>argDistinguishedName</span><span class=p>,</span> <span class=n>argDomain</span><span class=p>,</span> <span class=n>argDomainController</span><span class=p>,</span> <span class=s>&#34;samaccountname&#34;</span><span class=p>,</span> <span class=n>argMachineAccount</span><span class=p>,</span> <span class=n>argMachineAccount</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=n>argVerbose</span><span class=p>,</span> <span class=n>credential</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=申请st class=headerLink><a href=#%e7%94%b3%e8%af%b7st class=header-mark></a>申请ST</h3><p>Client向域控申请<code>WINSRVSERVER</code>的服务票据，域控在<code>HandleTGSRequest</code>函数中处理<code>TGS_REQ</code>请求。</p><p>首先通过<code>KerbFindPreAuthDataEntry</code>获取<code>TGS_REQ</code>中包含的<code>ApRequest</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>ApRequest</span> <span class=o>=</span> <span class=n>KerbFindPreAuthDataEntry</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>KRB5_PADATA_TGS_REQ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>RequestMessage</span><span class=o>-&gt;</span><span class=n>KERB_KDC_REQUEST_preauth_data</span>
</span></span><span class=line><span class=cl>                <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>之后便是解析获得的<code>APRequest</code>获得解密后的<code>TGT</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//验证请求。这包括对AP请求进行解码，找到合适的密钥来解密票据，并检查票据。
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KdcVerifyKdcRequest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ApRequest</span><span class=o>-&gt;</span><span class=n>preauth_data</span><span class=p>.</span><span class=n>value</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ApRequest</span><span class=o>-&gt;</span><span class=n>preauth_data</span><span class=p>.</span><span class=n>length</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ClientAddress</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>TRUE</span><span class=p>,</span>                           <span class=c1>// this is a kdc request
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>&amp;</span><span class=n>UnmarshalledApRequest</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>UnmarshalledAuthenticator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>SourceEncryptPart</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>ReplyKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>SourceTicketKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>ServerTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>UseSubKey</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pExtendedError</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>KdcVerifyKdcRequest做了以下几件事情</p><ul><li>KdcVerifyKdcRequest<ul><li>解包ApRequest &mdash;- KerbUnpackApRequest</li><li>根据其中的服务名（kbrtgt）获取服务的相关信息 &mdash;- KdcNormalize</li><li>通过相关信息找到服务的Hash &mdash;- KerbGetKeyFromList</li><li>解密TGT &mdash; KerbCheckTicket<ul><li>获得解密后的TGT &mdash; KerbVerifyTicket</li><li>用TGT中的Key（key为Client与KDC通信所需要的LogonSessionKey）解密获得Authenticator &mdash; KerbUnpackAuthenticator</li></ul></li><li>……（校验检查之类的）</li></ul></li></ul><p>查看这个函数的结果，获得了传过来的明文<code>TGT</code>和<code>krbtgt</code>的相关服务信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt ServerTicketInfo
</span></span><span class=line><span class=cl>Local var @ 0x327fc48 Type _KDC_TICKET_INFO
</span></span><span class=line><span class=cl>   +0x000 AccountName      : _UNICODE_STRING &#34;krbtgt&#34;
</span></span><span class=line><span class=cl>   +0x008 TrustedForest    : _UNICODE_STRING &#34;&#34;
</span></span><span class=line><span class=cl>   +0x010 PasswordExpires  : _LARGE_INTEGER 0x7fffffff`ffffffff
</span></span><span class=line><span class=cl>   +0x018 fTicketOpts      : 0x7b
</span></span><span class=line><span class=cl>   +0x01c UserAccountControl : 0x11
</span></span><span class=line><span class=cl>   +0x020 UserId           : 0x1f6
</span></span><span class=line><span class=cl>   +0x024 TrustType        : 0
</span></span><span class=line><span class=cl>   +0x028 TrustAttributes  : 0
</span></span><span class=line><span class=cl>   +0x02c Passwords        : 0x00084bf0 _KERB_STORED_CREDENTIAL
</span></span><span class=line><span class=cl>   +0x030 OldPasswords     : 0x000c4010 _KERB_STORED_CREDENTIAL
</span></span><span class=line><span class=cl>   +0x034 TrustSid         : (null) 
</span></span><span class=line><span class=cl>   +0x038 PasswordVersion  : 2
</span></span><span class=line><span class=cl>   +0x03c LockoutThreshold : 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kd&gt; dt SourceEncryptPart
</span></span><span class=line><span class=cl>Local var @ 0x327fdd0 Type KERB_ENCRYPTED_TICKET*
</span></span><span class=line><span class=cl>0x000fcf90 
</span></span><span class=line><span class=cl>   +0x000 bit_mask         : 0xd0
</span></span><span class=line><span class=cl>   +0x000 o                : [1]  &#34;???&#34;
</span></span><span class=line><span class=cl>   +0x004 flags            : tagASN1bitstring_t
</span></span><span class=line><span class=cl>   +0x00c key              : KERB_ENCRYPTION_KEY
</span></span><span class=line><span class=cl>   +0x018 client_realm     : 0x00106a18  &#34;RENPENGYU03.COM&#34;
</span></span><span class=line><span class=cl>   +0x01c client_name      : KERB_PRINCIPAL_NAME
</span></span><span class=line><span class=cl>   +0x024 transited        : KERB_TRANSITED_ENCODING
</span></span><span class=line><span class=cl>   +0x030 authtime         : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x03e starttime        : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x04c endtime          : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x05a renew_until      : tagASN1generalizedtime_t
</span></span><span class=line><span class=cl>   +0x068 client_addresses : (null) 
</span></span><span class=line><span class=cl>   +0x06c authorization_data : 0x000c3370 PKERB_AUTHORIZATION_DATA_s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kd&gt; db authorization_data l 276
</span></span><span class=line><span class=cl>0017f168  30 82 02 72 30 82 02 6e-a0 04 02 02 00 80 a1 82  0..r0..n........
</span></span><span class=line><span class=cl>0017f178  02 64 04 82 02 60 04 00-00 00 00 00 00 00 01 00  .d...`..........
</span></span><span class=line><span class=cl>0017f188  00 00 c0 01 00 00 48 00-00 00 00 00 00 00 0a 00  ......H.........
</span></span><span class=line><span class=cl>0017f198  00 00 22 00 00 00 08 02-00 00 00 00 00 00 06 00  ..&#34;.............
</span></span><span class=line><span class=cl>0017f1a8  00 00 14 00 00 00 30 02-00 00 00 00 00 00 07 00  ......0.........
</span></span><span class=line><span class=cl>0017f1b8  00 00 14 00 00 00 48 02-00 00 00 00 00 00 01 10  ......H.........
</span></span><span class=line><span class=cl>0017f1c8  08 00 cc cc cc cc b0 01-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f1d8  02 00 02 4e 81 c8 1c f7-d7 01 ff ff ff ff ff ff  ...N............
</span></span><span class=line><span class=cl>0017f1e8  ff 7f ff ff ff ff ff ff-ff 7f 56 b9 d8 d7 0f f7  ..........V.....
</span></span><span class=line><span class=cl>0017f1f8  d7 01 56 79 42 02 d9 f7-d7 01 ff ff ff ff ff ff  ..VyB...........
</span></span><span class=line><span class=cl>0017f208  ff 7f 18 00 18 00 04 00-02 00 00 00 00 00 08 00  ................
</span></span><span class=line><span class=cl>0017f218  02 00 00 00 00 00 0c 00-02 00 00 00 00 00 10 00  ................
</span></span><span class=line><span class=cl>0017f228  02 00 00 00 00 00 14 00-02 00 00 00 00 00 18 00  ................
</span></span><span class=line><span class=cl>0017f238  02 00 08 00 00 00 72 04-00 00 03 02 00 00 01 00  ......r.........
</span></span><span class=line><span class=cl>0017f248  00 00 1c 00 02 00 20 00-00 00 00 00 00 00 00 00  ...... .........
</span></span><span class=line><span class=cl>0017f258  00 00 00 00 00 00 00 00-00 00 18 00 1a 00 20 00  .............. .
</span></span><span class=line><span class=cl>0017f268  02 00 16 00 18 00 24 00-02 00 28 00 02 00 00 00  ......$...(.....
</span></span><span class=line><span class=cl>0017f278  00 00 00 00 00 00 80 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f288  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f298  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f2a8  00 00 00 00 00 00 00 00-00 00 0c 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f2b8  00 00 0c 00 00 00 57 00-49 00 4e 00 53 00 52 00  ......W.I.N.S.R.
</span></span><span class=line><span class=cl>0017f2c8  56 00 53 00 45 00 52 00-56 00 45 00 52 00 00 00  V.S.E.R.V.E.R...
</span></span><span class=line><span class=cl>0017f2d8  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f2e8  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f2f8  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................
</span></span><span class=line><span class=cl>0017f308  00 00 00 00 00 00 00 00-00 00 01 00 00 00 03 02  ................
</span></span><span class=line><span class=cl>0017f318  00 00 07 00 00 00 0d 00-00 00 00 00 00 00 0c 00  ................
</span></span><span class=line><span class=cl>0017f328  00 00 57 00 49 00 4e 00-53 00 52 00 56 00 53 00  ..W.I.N.S.R.V.S.
</span></span><span class=line><span class=cl>0017f338  45 00 52 00 56 00 45 00-52 00 0c 00 00 00 00 00  E.R.V.E.R.......
</span></span><span class=line><span class=cl>0017f348  00 00 0b 00 00 00 52 00-45 00 4e 00 50 00 45 00  ......R.E.N.P.E.
</span></span><span class=line><span class=cl>0017f358  4e 00 47 00 59 00 55 00-30 00 33 00 00 00 04 00  N.G.Y.U.0.3.....
</span></span><span class=line><span class=cl>0017f368  00 00 01 04 00 00 00 00-00 05 15 00 00 00 db ac  ................
</span></span><span class=line><span class=cl>0017f378  e2 f8 a5 b2 f3 d1 a1 c4-3e 10 00 00 00 00 00 06  ........&gt;.......
</span></span><span class=line><span class=cl>0017f388  7d ec a5 f7 d7 01 18 00-57 00 49 00 4e 00 53 00  }.......W.I.N.S.
</span></span><span class=line><span class=cl>0017f398  52 00 56 00 53 00 45 00-52 00 56 00 45 00 52 00  R.V.S.E.R.V.E.R.
</span></span><span class=line><span class=cl>0017f3a8  00 00 00 00 00 00 76 ff-ff ff 51 30 b4 c6 f1 8c  ......v...Q0....
</span></span><span class=line><span class=cl>0017f3b8  bf 3d 01 2f 7c 3d 75 9b-9d 8d 00 00 00 00 76 ff  .=./|=u.......v.
</span></span><span class=line><span class=cl>0017f3c8  ff ff 5a 8c df 90 88 38-ec 5d 6c 61 b8 46 bd bf  ..Z....8.]la.F..
</span></span><span class=line><span class=cl>0017f3d8  99 5c 00 00 00 00                                .\....
</span></span></code></pre></td></tr></table></div></div><p>之后会获取请求的相关信息</p><ul><li>在REQUEST_BODY中获得ServerName</li><li>在TGT中获得cname和crealm</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KerbConvertPrincipalNameToKdcName</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>ServerName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>RequestBody</span><span class=o>-&gt;</span><span class=n>KERB_KDC_REQUEST_BODY_server_name</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KerbConvertPrincipalNameToKdcName</span><span class=p>(</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>SourceClientName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>SourceEncryptPart</span><span class=o>-&gt;</span><span class=n>client_name</span>
</span></span><span class=line><span class=cl>               <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KerbConvertRealmToUnicodeString</span><span class=p>(</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>SourceClientRealm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>SourceEncryptPart</span><span class=o>-&gt;</span><span class=n>client_realm</span>
</span></span><span class=line><span class=cl>               <span class=p>);</span>           
</span></span></code></pre></td></tr></table></div></div><p>内容分别如下</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt ServerName
</span></span><span class=line><span class=cl>Local var @ 0x327fdd8 Type _KERB_INTERNAL_NAME*
</span></span><span class=line><span class=cl>0x00117610 
</span></span><span class=line><span class=cl>   +0x000 NameType         : 0n1
</span></span><span class=line><span class=cl>   +0x002 NameCount        : 1
</span></span><span class=line><span class=cl>   +0x004 Names            : [1] _UNICODE_STRING &#34;WINSRVSERVER&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kd&gt; dt SourceClientName
</span></span><span class=line><span class=cl>Local var @ 0x327fdd4 Type _KERB_INTERNAL_NAME*
</span></span><span class=line><span class=cl>0x0017f3e8 
</span></span><span class=line><span class=cl>   +0x000 NameType         : 0n1
</span></span><span class=line><span class=cl>   +0x002 NameCount        : 1
</span></span><span class=line><span class=cl>   +0x004 Names            : [1] _UNICODE_STRING &#34;WINSRVSERVER&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kd&gt; dt SourceClientRealm
</span></span><span class=line><span class=cl>Local var @ 0x327fdc4 Type _UNICODE_STRING
</span></span><span class=line><span class=cl> &#34;RENPENGYU03.COM&#34;
</span></span><span class=line><span class=cl>   +0x000 Length           : 0x1e
</span></span><span class=line><span class=cl>   +0x002 MaximumLength    : 0x20
</span></span><span class=line><span class=cl>   +0x004 Buffer           : 0x00153578  &#34;RENPENGYU03.COM&#34;
</span></span></code></pre></td></tr></table></div></div><p>之后会调用<code>KdcFindS4UClientAndRealm</code>来获取<code>PA_DATA_FOR_USER</code>这个结构中的内容<br><code>KdcFindS4UClientAndRealm</code>函数会解析<code>PaList</code>并将其转换成<code>KERB_PA_FOR_USER</code>结构，目前需要注意的便是其中的<code>userName</code>是我们要请求的高权限用户的用户名<code>Administrator</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt S4URequest
</span></span><span class=line><span class=cl>Local var @ 0x327f9b0 Type KERB_PA_FOR_USER*
</span></span><span class=line><span class=cl>0x0012aaa8 
</span></span><span class=line><span class=cl>   +0x000 bit_mask         : 0
</span></span><span class=line><span class=cl>   +0x000 o                : [1]  &#34;&#34;
</span></span><span class=line><span class=cl>   +0x004 userName         : KERB_PRINCIPAL_NAME
</span></span><span class=line><span class=cl>   +0x00c userRealm        : 0x0012abf0  &#34;RENPENGYU03.COM&#34;
</span></span><span class=line><span class=cl>   +0x010 cksum            : KERB_CHECKSUM
</span></span><span class=line><span class=cl>   +0x01c authentication_package : 0x000fca30  &#34;Kerberos&#34;
</span></span><span class=line><span class=cl>   +0x020 authorization_data : tagASN1octetstring_t
</span></span><span class=line><span class=cl>kd&gt; dx -id 0,0,89de1678 -r1 (*((KDCSVC!KERB_PRINCIPAL_NAME *)0x12aaac))
</span></span><span class=line><span class=cl>(*((KDCSVC!KERB_PRINCIPAL_NAME *)0x12aaac))                 [Type: KERB_PRINCIPAL_NAME]
</span></span><span class=line><span class=cl>    [+0x000] name_type        : 10 [Type: long]
</span></span><span class=line><span class=cl>    [+0x004] name_string      : 0x82c98 [Type: KERB_PRINCIPAL_NAME_name_string_s *]
</span></span><span class=line><span class=cl>kd&gt; dx -id 0,0,89de1678 -r1 ((KDCSVC!KERB_PRINCIPAL_NAME_name_string_s *)0x82c98)
</span></span><span class=line><span class=cl>((KDCSVC!KERB_PRINCIPAL_NAME_name_string_s *)0x82c98)                 : 0x82c98 [Type: KERB_PRINCIPAL_NAME_name_string_s *]
</span></span><span class=line><span class=cl>    [+0x000] next             : 0x0 [Type: KERB_PRINCIPAL_NAME_name_string_s *]
</span></span><span class=line><span class=cl>    [+0x004] value            : 0x159c88 : &#34;renpengServer&#34; [Type: char *]
</span></span></code></pre></td></tr></table></div></div><p>之后会通过<code>KdcNormalize</code>获取我们自身<code>WINSRVSERVER</code>的相关信息<br>其中的关键调用如下：</p><ul><li>KdcNormalize<ul><li>KdcGetTicketInfo<ul><li>SamIGetUserLogonInformation2 (WINSRVSERVER)</li><li>SamIGetUserLogonInformation2 (WINSRVSERVER$)</li></ul></li></ul></li></ul><p>对于漏洞的利用便发生在这个函数中，并且利用了两次。<br>第一次实现了将申请的用户转换为域控上的<code>Administrator</code>
第二次实现了将申请的服务转换成<code>WINSRVSERVER$</code><br>下面将详细分析漏洞点。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>KERBERR</span>
</span></span><span class=line><span class=cl><span class=n>KdcNormalize</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>PKERB_INTERNAL_NAME</span> <span class=n>PrincipalName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>OPTIONAL</span> <span class=n>PUNICODE_STRING</span> <span class=n>PrincipalRealm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>OPTIONAL</span> <span class=n>PUNICODE_STRING</span> <span class=n>RequestRealm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>OPTIONAL</span> <span class=n>PUNICODE_STRING</span>  <span class=n>TgtClientRealm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>ULONG</span> <span class=n>NameFlags</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>BOOLEAN</span> <span class=n>bRestrictUserAccounts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>PBOOLEAN</span> <span class=n>Referral</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>PUNICODE_STRING</span> <span class=n>RealmName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>PKDC_TICKET_INFO</span> <span class=n>TicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>PKERB_EXT_ERROR</span>  <span class=n>pExtendedError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>OPTIONAL</span> <span class=n>SAMPR_HANDLE</span> <span class=o>*</span> <span class=n>UserHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>OPTIONAL</span> <span class=n>ULONG</span> <span class=n>WhichFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>IN</span> <span class=n>OPTIONAL</span> <span class=n>ULONG</span> <span class=n>ExtendedFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>OPTIONAL</span> <span class=n>PUSER_INTERNAL6_INFORMATION</span> <span class=o>*</span> <span class=n>UserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>OUT</span> <span class=n>OPTIONAL</span> <span class=n>PSID_AND_ATTRIBUTES_LIST</span> <span class=n>GroupMembership</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>调用<code>KdcNormalize</code>时的相关参数中最重要的就是<code>SourceCName</code><br>因为我们是在利用<code>S4U2Self</code>协议请求自身的ST，所以<code>SourceCName</code>也就是自身的名字<code>WINSRVSERVER</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt SourceCName
</span></span><span class=line><span class=cl>Local var @ 0x327f9e0 Type _KERB_INTERNAL_NAME*
</span></span><span class=line><span class=cl>0x0016e920 
</span></span><span class=line><span class=cl>   +0x000 NameType         : 0n1
</span></span><span class=line><span class=cl>   +0x002 NameCount        : 1
</span></span><span class=line><span class=cl>   +0x004 Names            : [1] _UNICODE_STRING &#34;WINSRVSERVER&#34;
</span></span></code></pre></td></tr></table></div></div><p><del>此处还需要强调清理SPN的意义</del></p><p>之后在<code>CheckSam</code>条件中会调用到<code>KdcGetTicketInfo</code>来获取用户<code>WINSRVSERVER</code>的相关信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KdcGetTicketInfo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>OutputPrincipal</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=mi>0</span><span class=p>,</span>                  <span class=c1>// no lookup flags means sam name
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>bRestrictUserAccounts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>NULL</span><span class=p>,</span>               <span class=c1>// no principal name
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nb>NULL</span><span class=p>,</span>               <span class=c1>// no realm name,
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>TicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pExtendedError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>UserHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>WhichFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>ExtendedFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>UserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>GroupMembership</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>此时<code>OutputPrincipal</code>的值为<code>WINSRVSERVER</code>，即我们自己的机器名<code>DC</code>，目前仍一切正常</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt OutputPrincipal
</span></span><span class=line><span class=cl>Local var @ 0x327f928 Type _UNICODE_STRING
</span></span><span class=line><span class=cl> &#34;WINSRVSERVER&#34;
</span></span><span class=line><span class=cl>   +0x000 Length           : 0x18
</span></span><span class=line><span class=cl>   +0x002 MaximumLength    : 0x1a
</span></span><span class=line><span class=cl>   +0x004 Buffer           : 0x0016e92c  &#34;WINSRVSERVER&#34;
</span></span></code></pre></td></tr></table></div></div><p>之后会调用<code>SamIGetUserLogonInformation2</code>在SAM中查找对应的账户信息，但由于此时已经将创建的机器账号还原，所以并不能找到对应的账号，该函数会返回错误<br>但是系统并不会直接提示找不到账号，而是会在其后面添加&rsquo;$&lsquo;符号，将其作为机器账号再次查找</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl>   <span class=n>Status</span> <span class=o>=</span> <span class=n>SamIGetUserLogonInformation2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>               <span class=n>GlobalAccountDomainHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>LookupFlags</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>UserName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>WhichFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>ExtendedFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>UserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>LocalMembership</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>LocalUserHandle</span>
</span></span><span class=line><span class=cl>               <span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// WASBUG: For now, if we couldn&#39;t find the account try again
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// with a &#39;$&#39; at the end (if there wasn&#39;t one already)
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=p>(((</span><span class=n>Status</span> <span class=o>==</span> <span class=n>STATUS_NOT_FOUND</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=n>Status</span> <span class=o>==</span> <span class=n>STATUS_NO_SUCH_USER</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=o>!</span><span class=n>IsValidGuid</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=p>((</span><span class=n>LookupFlags</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>SAM_NO_MEMBERSHIPS</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=n>UserName</span><span class=o>-&gt;</span><span class=n>Length</span> <span class=o>&gt;=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>WCHAR</span><span class=p>))</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=n>UserName</span><span class=o>-&gt;</span><span class=n>Buffer</span><span class=p>[</span><span class=n>UserName</span><span class=o>-&gt;</span><span class=n>Length</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=n>WCHAR</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>!=</span> <span class=sa>L</span><span class=sc>&#39;$&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>Status</span> <span class=o>=</span> <span class=n>KerbDuplicateString</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>TempString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>UserName</span>
</span></span><span class=line><span class=cl>                  <span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>NT_SUCCESS</span><span class=p>(</span><span class=n>Status</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KRB_ERR_GENERIC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>goto</span> <span class=n>Cleanup</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>DsysAssert</span><span class=p>(</span><span class=n>TempString</span><span class=p>.</span><span class=n>MaximumLength</span> <span class=o>&gt;=</span> <span class=n>TempString</span><span class=p>.</span><span class=n>Length</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>WCHAR</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>TempString</span><span class=p>.</span><span class=n>Buffer</span><span class=p>[</span><span class=n>TempString</span><span class=p>.</span><span class=n>Length</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=n>WCHAR</span><span class=p>)]</span> <span class=o>=</span> <span class=sa>L</span><span class=sc>&#39;$&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>TempString</span><span class=p>.</span><span class=n>Length</span> <span class=o>+=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>WCHAR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>D_DebugLog</span><span class=p>((</span><span class=n>DEB_TRACE</span><span class=p>,</span> <span class=s>&#34;Account not found ,trying machine account %wZ</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>TempString</span> <span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>Status</span> <span class=o>=</span> <span class=n>SamIGetUserLogonInformation2</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                  <span class=n>GlobalAccountDomainHandle</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>LookupFlags</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>TempString</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>WhichFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>ExtendedFields</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>UserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>LocalMembership</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>LocalUserHandle</span>
</span></span><span class=line><span class=cl>                  <span class=p>);</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过调试信息可以清晰的看到查找到的用户信息不再是<code>WINSRVSERVER</code>而是变成了<code>WINSRVSERVER$</code>也就是域控对应的机器账号<code>UserId = 0x3ed</code><br>至此便完成了对于域控的欺骗，之后就是颁发ST的过程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; dt UserInfo
</span></span><span class=line><span class=cl>Local var @ 0x327f684 Type _USER_INTERNAL6_INFORMATION*
</span></span><span class=line><span class=cl>0x001602e0 
</span></span><span class=line><span class=cl>   +0x000 I1               : _USER_ALL_INFORMATION
</span></span><span class=line><span class=cl>   +0x0c8 LastBadPasswordTime : _LARGE_INTEGER 0x0
</span></span><span class=line><span class=cl>   +0x0d0 ExtendedFields   : 0x18
</span></span><span class=line><span class=cl>   +0x0d4 UPNDefaulted     : 0 &#39;&#39;
</span></span><span class=line><span class=cl>   +0x0d8 UPN              : _UNICODE_STRING &#34;&#34;
</span></span><span class=line><span class=cl>   +0x0e0 A2D2List         : (null) 
</span></span><span class=line><span class=cl>   +0x0e4 RegisteredSPNs   : (null) 
</span></span><span class=line><span class=cl>   +0x0e8 KeyVersionNumber : 5
</span></span><span class=line><span class=cl>   +0x0ec LockoutThreshold : 0
</span></span><span class=line><span class=cl>kd&gt; dx -id 0,0,89de1678 -r1 (*((KDCSVC!_USER_ALL_INFORMATION *)0x1602e0))
</span></span><span class=line><span class=cl>(*((KDCSVC!_USER_ALL_INFORMATION *)0x1602e0))                 [Type: _USER_ALL_INFORMATION]
</span></span><span class=line><span class=cl>    [+0x000] LastLogon        : {0} [Type: _LARGE_INTEGER]
</span></span><span class=line><span class=cl>    [+0x008] LastLogoff       : {0} [Type: _LARGE_INTEGER]
</span></span><span class=line><span class=cl>    [+0x010] PasswordLastSet  : {0} [Type: _LARGE_INTEGER]
</span></span><span class=line><span class=cl>    [+0x018] AccountExpires   : {0} [Type: _LARGE_INTEGER]
</span></span><span class=line><span class=cl>    [+0x020] PasswordCanChange : {0} [Type: _LARGE_INTEGER]
</span></span><span class=line><span class=cl>    [+0x028] PasswordMustChange : {9223372036854775807} [Type: _LARGE_INTEGER]
</span></span><span class=line><span class=cl>    [+0x030] UserName         : &#34;WINSRVSERVER$&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x038] FullName         : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x040] HomeDirectory    : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x048] HomeDirectoryDrive : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x050] ScriptPath       : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x058] ProfilePath      : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x060] AdminComment     : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x068] WorkStations     : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x070] UserComment      : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x078] Parameters       : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x080] LmPassword       : &#34;&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x088] NtPassword       : &#34;.㑟废띶䎓樾쒕ꇒ&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x090] PrivateData      : &#34;.&#34; [Type: _UNICODE_STRING]
</span></span><span class=line><span class=cl>    [+0x098] SecurityDescriptor [Type: _SR_SECURITY_DESCRIPTOR]
</span></span><span class=line><span class=cl>    [+0x0a0] UserId           : 0x3ed [Type: unsigned long]
</span></span><span class=line><span class=cl>    [+0x0a4] PrimaryGroupId   : 0x0 [Type: unsigned long]
</span></span><span class=line><span class=cl>    [+0x0a8] UserAccountControl : 0x2100 [Type: unsigned long]
</span></span><span class=line><span class=cl>    [+0x0ac] WhichFields      : 0x27120005 [Type: unsigned long]
</span></span><span class=line><span class=cl>    [+0x0b0] LogonHours       [Type: _LOGON_HOURS]
</span></span><span class=line><span class=cl>    [+0x0b8] BadPasswordCount : 0x0 [Type: unsigned short]
</span></span><span class=line><span class=cl>    [+0x0ba] LogonCount       : 0x0 [Type: unsigned short]
</span></span><span class=line><span class=cl>    [+0x0bc] CountryCode      : 0x0 [Type: unsigned short]
</span></span><span class=line><span class=cl>    [+0x0be] CodePage         : 0x0 [Type: unsigned short]
</span></span><span class=line><span class=cl>    [+0x0c0] LmPasswordPresent : 0x0 [Type: unsigned char]
</span></span><span class=line><span class=cl>    [+0x0c1] NtPasswordPresent : 0x1 [Type: unsigned char]
</span></span><span class=line><span class=cl>    [+0x0c2] PasswordExpired  : 0x0 [Type: unsigned char]
</span></span><span class=line><span class=cl>    [+0x0c3] PrivateDataSensitive : 0x1 [Type: unsigned char]
</span></span></code></pre></td></tr></table></div></div><p>至此，我们成功的请求的用户<code>WINSRVSERVER</code>伪装成了域控自身<code>WINSRVSERVER$</code></p><p>之后再<code>I_GetTGSTicket</code>中，为了获得<code>WINSRVSERVER</code>这个服务的相关信息，又再次调用<code>KdcNormalize</code>，其中的流程与上述基本相同，这也就是漏洞的第二次利用。成功的将请求的服务从<code>WINSRVSERVER</code>伪装成<code>WINSRVSERVER$</code></p><p>完成上述的两次利用后，其他过程都显得不再重要，但有一点仍然需要留意，便是关于PAC的问题。<br>之前TGT中的PAC主体为<code>WINSRVSERVER</code>，又是如何切换为申请的<code>Administrator</code>的，对于之前的PAC又是如何处理的。<br>下面将对这两点进行分析</p><p><code>S4U2self</code>协议的意义是 服务器模拟用户向域控申请针对自身的ST，即给予用户访问服务的权限，所以返回的ST中应该插入的是用户的PAC，即下图中的(2)(3)两个过程<br>而上一步中我们申请的TGT中的PAC，是 不在下图中的Service1向KDC认证的过程 中颁发的PAC<br>明白了这点也就明白了为什么PAC会被替换</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/S4U2self.png title="Server-for-User-to-Self (S4U2self)" data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/S4U2self.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/S4U2self.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/S4U2self.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/S4U2self.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/S4U2self.png 2x" sizes=auto alt="Server-for-User-to-Self (S4U2self)"></a></figure></p><p>以下堆栈及函数完成了生成ST并向其中添加了用户PAC</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kd&gt; kb
</span></span><span class=line><span class=cl> # ChildEBP RetAddr      Args to Child              
</span></span><span class=line><span class=cl>00 0327f9ac 61ba4b9b     0327fb48 0327fea8 0327fea0 KDCSVC!I_GetTGSTicket+0x313   
</span></span><span class=line><span class=cl>01 0327fe44 61ba1901     00160958 000c5020 0327feb8 KDCSVC!HandleTGSRequest+0x77f   
</span></span><span class=line><span class=cl>02 0327fee0 61bae51e     0327ff30 00160958 00160968 KDCSVC!KdcGetTicket+0x25e    
</span></span><span class=line><span class=cl>03 0327ff34 70d173e6     00160940 00000562 00000000 KDCSVC!KdcAtqIoCompletion+0x15f  
</span></span><span class=line><span class=cl>04 0327ff58 70d18808     00000562 00000000 00084df4 NTDSATQ!ATQ_CONTEXT::IOCompletion+0x53 
</span></span><span class=line><span class=cl>05 0327ff84 70d189f2     00000000 00000562 00084df4 NTDSATQ!AtqpProcessContext+0x3c2  
</span></span><span class=line><span class=cl>06 0327ffb8 77e41be7     abcdef01 00000000 00000000 NTDSATQ!AtqPoolThread+0xbd    
</span></span><span class=line><span class=cl>07 0327ffec 00000000     70d18935 abcdef01 00000000 kernel32!BaseThreadStart+0x34   
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KdcGetS4UTicketInfo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                  <span class=n>S4UTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>OldServiceTicketInfo</span><span class=p>,</span> <span class=c1>// tgt&#39;s account info.
</span></span></span><span class=line><span class=cl><span class=c1></span>                  <span class=o>&amp;</span><span class=n>S4UClientUserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=o>&amp;</span><span class=n>S4UClientGroupMembership</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>pExtendedError</span>
</span></span><span class=line><span class=cl>                  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>BuildTicketTGS</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>ServiceTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>RequestBody</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>SourceTicket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>Referral</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>S4UTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>CommonEType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>NewTicket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>pExtendedError</span>
</span></span><span class=line><span class=cl>            <span class=p>);</span>  
</span></span><span class=line><span class=cl><span class=p>...</span>         
</span></span><span class=line><span class=cl><span class=n>KerbErr</span> <span class=o>=</span> <span class=n>KdcInsertInitialS4UAuthorizationData</span><span class=p>(</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>EncryptedTicket</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>pExtendedError</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>S4UTicketInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=n>S4UClientUserInfo</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=o>&amp;</span><span class=n>S4UClientGroupMembership</span><span class=p>,</span>
</span></span><span class=line><span class=cl>               <span class=p>((</span><span class=n>ServiceTicketInfo</span><span class=o>-&gt;</span><span class=n>UserId</span> <span class=o>!=</span> <span class=n>DOMAIN_USER_RID_KRBTGT</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                     <span class=p>((</span><span class=n>ServiceTicketInfo</span><span class=o>-&gt;</span><span class=n>UserAccountControl</span> <span class=o>&amp;</span> <span class=n>USER_INTERDOMAIN_TRUST_ACCOUNT</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>               <span class=n>pKeyToUse</span>
</span></span><span class=line><span class=cl>               <span class=p>);</span>                                             
</span></span></code></pre></td></tr></table></div></div><p>对于原本的TGT中的PAC并没有做任何处理，直接将其丢弃了。</p><h2 id=总结 class=headerLink><a href=#%e6%80%bb%e7%bb%93 class=header-mark></a>总结</h2><p>本文介绍了<code>CVE-2021-42278</code>和<code>CVE-2021-42287</code>的漏洞背景,并从系统层面详细分析了漏洞成因，其关键点在于<code>S4U2self</code>过程中的欺骗。<br>对于任何技术的研究，都不要靠想当然。用苍白的文字来理解协议，远不如用可靠的代码和调试信息。</p><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><p><a href=https://www.rfc-editor.org/rfc/rfc4120.txt target=_blank rel="noopener noreferrer">https://www.rfc-editor.org/rfc/rfc4120.txt</a><br><a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/1fb9caca-449f-4183-8f7a-1a5fc7e7290a target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/1fb9caca-449f-4183-8f7a-1a5fc7e7290a</a><br><a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/aceb70de-40f0-4409-87fa-df00ca145f5a target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/aceb70de-40f0-4409-87fa-df00ca145f5a</a><br><a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/ae60c948-fda8-45c2-b1d1-a71b484dd1f7 target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/ae60c948-fda8-45c2-b1d1-a71b484dd1f7</a><br><a href=https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/c38cc307-f3e6-4ed4-8c81-dc550d96223c target=_blank rel="noopener noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/c38cc307-f3e6-4ed4-8c81-dc550d96223c</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-12-30</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/index.txt target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析"><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer=facebook data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析" data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="分享到 Line" data-sharer=line data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析"><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="分享到 微博" data-sharer=weibo data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析"><span class="fab fa-weibo fa-fw"></span></button><button title="分享到 Myspace" data-sharer=myspace data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析" data-description><span data-svg-src=/lib/simple-icons/icons/myspace.min.svg></span></button><button title="分享到 Blogger" data-sharer=blogger data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析" data-description><span class="fab fa-blogger fa-fw"></span></button><button title="分享到 Evernote" data-sharer=evernote data-url=http://dre4merp.github.io/2021/12/samaccountname-spoofing-%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ data-title="sAMAccountName spoofing 完整分析"><span class="fab fa-evernote fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2021/12/kerberos-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ class=prev rel=prev title="Kerberos 学习笔记"><i class="fas fa-angle-left fa-fw"></i>Kerberos 学习笔记</a>
<a href=/2021/12/printnightmare-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ class=next rel=next title="PrintNightmare 漏洞复现及分析">PrintNightmare 漏洞复现及分析<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>dre4merp is trying harder.</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/dre4merp target=_blank rel="noopener noreferrer">dre4merp</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div id=cookieconsent-container></div><div class=assets><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/js/cookieconsent.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KDR7NTQEPH",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-KDR7NTQEPH" async></script></div></body></html>