<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>PrintNightmare漏洞复现及分析 - dre4merp's blog</title><meta name=Description content="This is dre4merp's blog."><meta property="og:title" content="PrintNightmare漏洞复现及分析">
<meta property="og:description" content="漏洞简介前段时间，微软公布了名为Windows PrintNightmare的安全漏洞，获得编号CVE-2021-34527。其与漏洞CVE-"><meta property="og:type" content="article"><meta property="og:url" content="http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/"><meta property="og:image" content="http://dre4merp.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-31T23:34:08+08:00"><meta property="article:modified_time" content="2021-12-31T23:34:08+08:00"><meta property="og:site_name" content="dre4merp's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://dre4merp.github.io/logo.png"><meta name=twitter:title content="PrintNightmare漏洞复现及分析"><meta name=twitter:description content="漏洞简介前段时间，微软公布了名为Windows PrintNightmare的安全漏洞，获得编号CVE-2021-34527。其与漏洞CVE-"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/><link rel=prev href=http://dre4merp.github.io/samaccountname-spoofing%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/><link rel=next href=http://dre4merp.github.io/cve-2022-22947%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"PrintNightmare漏洞复现及分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/dre4merp.github.io\/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90\/"},"genre":"posts","wordcount":1855,"url":"http:\/\/dre4merp.github.io\/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90\/","datePublished":"2021-12-31T23:34:08+08:00","dateModified":"2021-12-31T23:34:08+08:00","publisher":{"@type":"Organization","name":""},"authors":[{"@type":"Person","name":"dre4merp"}],"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"dark"==="light"||"dark"==="dark"||"dark"==="black"?(setTheme("dark"),saveTheme("dark")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>归档 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于我 </a><a class=menu-item href=/index.xml>订阅 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>归档</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于我</a><a class=menu-item href=/index.xml title>订阅</a><a href=javascript:void(0); class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#漏洞简介>漏洞简介</a></li><li><a href=#漏洞分析>漏洞分析</a><ul><li><a href=#漏洞点分析>漏洞点分析</a></li><li><a href=#漏洞具体分析>漏洞具体分析</a><ul><li><a href=#越过权限校验>越过权限校验</a></li><li><a href=#检查驱动签名>检查驱动签名</a></li><li><a href=#建立驱动文件列表>建立驱动文件列表</a></li><li><a href=#检查驱动兼容性>检查驱动兼容性</a></li><li><a href=#拷贝驱动文件>拷贝驱动文件</a></li></ul></li></ul></li><li><a href=#漏洞利用条件>漏洞利用条件</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">PrintNightmare漏洞复现及分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class="author fas fa-user-circle fa-fw"></span><span class=screen-reader-text> </span><a href=http://dre4merp.github.io/authors/dre4merp>dre4merp</a></span></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2021-12-31>2021-12-31</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2021-12-31>2021-12-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1855 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#漏洞简介>漏洞简介</a></li><li><a href=#漏洞分析>漏洞分析</a><ul><li><a href=#漏洞点分析>漏洞点分析</a></li><li><a href=#漏洞具体分析>漏洞具体分析</a><ul><li><a href=#越过权限校验>越过权限校验</a></li><li><a href=#检查驱动签名>检查驱动签名</a></li><li><a href=#建立驱动文件列表>建立驱动文件列表</a></li><li><a href=#检查驱动兼容性>检查驱动兼容性</a></li><li><a href=#拷贝驱动文件>拷贝驱动文件</a></li></ul></li></ul></li><li><a href=#漏洞利用条件>漏洞利用条件</a></li></ul></nav></div></div><div class=content id=content><h2 id=漏洞简介 class=headerLink><a href=#%e6%bc%8f%e6%b4%9e%e7%ae%80%e4%bb%8b class=header-mark></a>漏洞简介</h2><p>前段时间，微软公布了名为<code>Windows PrintNightmare</code>的安全漏洞，获得编号<code>CVE-2021-34527</code>。其与漏洞<code>CVE-2021-1675</code>极其相似，都是通过加载DLL的方式实现代码执行。未经身份验证的远程攻击者可利用该漏洞以SYSTEM权限在域控制器上执行任意代码，从而获得整个域的控制权。微软对于该漏洞的修补工作并没有一步到位，在第一次漏洞爆出并发布修补程序后，仍可以通过其他方式绕过补丁继续利用该漏洞，微软不得不二次进行修补才成功杜绝该漏洞所带来的安全问题。</p><p>影响范围：Windows Server 2008-Windows Server 2019</p><h2 id=漏洞分析 class=headerLink><a href=#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90 class=header-mark></a>漏洞分析</h2><h3 id=漏洞点分析 class=headerLink><a href=#%e6%bc%8f%e6%b4%9e%e7%82%b9%e5%88%86%e6%9e%90 class=header-mark></a>漏洞点分析</h3><p><code>CVE-2021-1675</code>的漏洞点位于<code>RpcAddPrinterDriverEx</code>中,<code>CVE-2021-34527</code>的漏洞点位于<code>RpcAsyncAddPrinterDriver</code>中。系统在对上述两个函数进行相关处理后，都调用了<code>YAddPrinterDriverEx</code>函数，但是这个过程并没有对参数<code>dwFileCopyFlags</code>进行条件判断，所以可以添加一个标志<code>APD_INSTALL_WARNED_DRIVER</code>，使得添加打印机驱动时，以system权限加载恶意DLL。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.016></a></figure></p><p>Mimikatz中针对PrintNightmare攻击的实现代码</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.002></a></figure><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.003></a></figure><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.004></a></figure></p><p>两个漏洞分别的漏洞点</p><h3 id=漏洞具体分析 class=headerLink><a href=#%e6%bc%8f%e6%b4%9e%e5%85%b7%e4%bd%93%e5%88%86%e6%9e%90 class=header-mark></a>漏洞具体分析</h3><h4 id=越过权限校验 class=headerLink><a href=#%e8%b6%8a%e8%bf%87%e6%9d%83%e9%99%90%e6%a0%a1%e9%aa%8c class=header-mark></a>越过权限校验</h4><p>通过<code>YAddPrinterDriverEx</code>添加打印机驱动时，Windows原本会在<code>SplAddPrinterDriverEx</code>中通过<code>ValidateObjectAccess</code>对当前用户权限进行校验，如果权限校验失败将无法加载驱动。但是由于添加了标志<code>APD_INSTALL_WARNED_DRIVER(0x8000)</code>，所以成功越过了对于权限的检查。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.005></a></figure></p><p><code>YAddPrinterDriverEx</code>本地的内部实现位于<code>localspl.dll</code>中的<code>InternalAddPrinterDriverEx</code>函数，添加驱动的过程如下：</p><p>检查驱动签名
建立驱动文件列表
检查驱动兼容性
拷贝驱动文件</p><p>如果能够绕过其中的限制，将恶意DLL复制到驱动目录并加载，就可以完成本地提权。</p><h4 id=检查驱动签名 class=headerLink><a href=#%e6%a3%80%e6%9f%a5%e9%a9%b1%e5%8a%a8%e7%ad%be%e5%90%8d class=header-mark></a>检查驱动签名</h4><p><code>localspl!ValidateDriverInfo</code>在如下代码会校验加载驱动的签名，可以使用0x8000的<code>dwFileCopyFlags</code>绕过，0x8000即<code>RpcAddPrinterDriverEx</code> 的API文档中提到的<code>APD_INSTALL_WARNED_DRIVER</code>，翻译过来即强制加载驱动。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.006></a></figure><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.007></a></figure></p><h4 id=建立驱动文件列表 class=headerLink><a href=#%e5%bb%ba%e7%ab%8b%e9%a9%b1%e5%8a%a8%e6%96%87%e4%bb%b6%e5%88%97%e8%a1%a8 class=header-mark></a>建立驱动文件列表</h4><p><code>localspl!CreateInternalDriverFileArray</code>中会使用如下代码根据<code>RpcAddPrinterDriverEx</code>的<code>dwFileCopyFlags</code>参数生成<code>CreateFile</code>的参数，根据文件操作标志来决定是否检查spool驱动目录。在<code>CreateInternalDriverFileArray</code>中，如果 a5 flag被标志为False，驱动加载函数只会检查用户目录中是否包含要拷贝的驱动文件；否则，函数会尝试到spool驱动目录寻找目标驱动，这将导致列表建立失败。通过分析可以发现，在<code>FileCopyFlags</code>中设置<code>APD_COPY_FROM_DIRECTORY(0x10)</code>，即可跳过spool目录检查。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.008></a></figure><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.009></a></figure></p><h4 id=检查驱动兼容性 class=headerLink><a href=#%e6%a3%80%e6%9f%a5%e9%a9%b1%e5%8a%a8%e5%85%bc%e5%ae%b9%e6%80%a7 class=header-mark></a>检查驱动兼容性</h4><p><code>localsp!InternalAddPrinterDriverEx</code>会通过<code>GetPrintDriverVersion</code>获得驱动文件的版本号并对其进行检查。如果其等于2或大于3则不兼容而无法加载。之后的驱动兼容性检查通过<code>SplIsCompatibleDriver</code>进行，而其内部实现<code>ntprint!InternalCompatibleInfDriverCheck</code>又限制了版本号只能大于2，所以恶意DLL必须设置版本号为3。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.010></a></figure><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.011></a></figure><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.012></a></figure></p><h4 id=拷贝驱动文件 class=headerLink><a href=#%e6%8b%b7%e8%b4%9d%e9%a9%b1%e5%8a%a8%e6%96%87%e4%bb%b6 class=header-mark></a>拷贝驱动文件</h4><p>驱动文件拷贝函数<code>CopyFileToFinalDirectory</code>会将恶意DLL及其依赖拷贝到<code>%spooler%\drivers\x64\3</code>目录下并自动加载。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013.png title=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013 data-thumbnail=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013.png><img loading=lazy src=https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013.png srcset="https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013.png, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013.png 1.5x, https://cdn.jsdelivr.net/gh/dre4merp/Drawing-bed@main/images/Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013.png 2x" sizes=auto alt=Aspose.Words.2a55de83-1c35-49eb-98b2-393b538b46b8.013></a></figure></p><h2 id=漏洞利用条件 class=headerLink><a href=#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8%e6%9d%a1%e4%bb%b6 class=header-mark></a>漏洞利用条件</h2><p>当攻击机为域内一台Windows主机时，为了实现恶意DLL从域内主机到域控的横向移动，需要在主机上创建一个共享文件夹用以存放恶意DLL，并且需要允许Everyone和Anonymous对该文件夹进行访问。此外，需要将该共享设置为允许匿名的网络访问。通过注册表设置的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>mkdir</span> <span class=n>C:</span><span class=p>\</span><span class=n>share</span>
</span></span><span class=line><span class=cl><span class=n>icacls</span> <span class=n>C:</span><span class=p>\</span><span class=n>share</span><span class=p>\</span> <span class=p>/</span><span class=n>T</span> <span class=p>/</span><span class=n>grant</span> <span class=n>Anonymous</span><span class=p>`</span> <span class=n>logon</span><span class=err>:</span><span class=nb>r
</span></span></span><span class=line><span class=cl><span class=nb></span><span class=n>icacls</span> <span class=n>C:</span><span class=p>\</span><span class=n>share</span><span class=p>\</span> <span class=p>/</span><span class=n>T</span> <span class=p>/</span><span class=n>grant</span> <span class=n>Everyone</span><span class=err>:</span><span class=nb>r
</span></span></span><span class=line><span class=cl><span class=nb>New-SmbShare</span> <span class=n>-Path</span> <span class=n>C:</span><span class=p>\</span><span class=n>share</span> <span class=n>-Name</span> <span class=n>share</span> <span class=n>-ReadAccess</span> <span class=s1>&#39;ANONYMOUS LOGON&#39;</span><span class=p>,</span><span class=s1>&#39;Everyone&#39;</span>
</span></span><span class=line><span class=cl><span class=n>REG</span> <span class=n>ADD</span> <span class=s2>&#34;HKLM\System\CurrentControlSet\Services\LanManServer\Parameters&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>NullSessionPipes</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_MULTI_SZ</span> <span class=p>/</span><span class=n>d</span> <span class=n>srvsvc</span> <span class=p>/</span><span class=n>f</span> 
</span></span><span class=line><span class=cl><span class=n>REG</span> <span class=n>ADD</span> <span class=s2>&#34;HKLM\System\CurrentControlSet\Services\LanManServer\Parameters&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>NullSessionShares</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_MULTI_SZ</span> <span class=p>/</span><span class=n>d</span> <span class=n>share</span> <span class=p>/</span><span class=n>f</span>
</span></span><span class=line><span class=cl><span class=n>REG</span> <span class=n>ADD</span> <span class=s2>&#34;HKLM\System\CurrentControlSet\Control\Lsa&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>EveryoneIncludesAnonymous</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_DWORD</span> <span class=p>/</span><span class=n>d</span> <span class=mf>1</span> <span class=p>/</span><span class=n>f</span>
</span></span><span class=line><span class=cl><span class=n>REG</span> <span class=n>ADD</span> <span class=s2>&#34;HKLM\System\CurrentControlSet\Control\Lsa&#34;</span> <span class=p>/</span><span class=n>v</span> <span class=n>RestrictAnonymous</span> <span class=p>/</span><span class=n>t</span> <span class=n>REG_DWORD</span> <span class=p>/</span><span class=n>d</span> <span class=mf>0</span> <span class=p>/</span><span class=n>f</span>
</span></span><span class=line><span class=cl><span class=c># Reboot</span>
</span></span></code></pre></td></tr></table></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2021-12-31</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/index.txt target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer=facebook data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析 data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="分享到 Line" data-sharer=line data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="分享到 微博" data-sharer=weibo data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析><span class="fab fa-weibo fa-fw"></span></button><button title="分享到 Myspace" data-sharer=myspace data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析 data-description><span data-svg-src=/lib/simple-icons/icons/myspace.min.svg></span></button><button title="分享到 Blogger" data-sharer=blogger data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析 data-description><span class="fab fa-blogger fa-fw"></span></button><button title="分享到 Evernote" data-sharer=evernote data-url=http://dre4merp.github.io/printnightmare%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ data-title=PrintNightmare漏洞复现及分析><span class="fab fa-evernote fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/samaccountname-spoofing%E5%AE%8C%E6%95%B4%E5%88%86%E6%9E%90/ class=prev rel=prev title="sAMAccountName spoofing完整分析"><i class="fas fa-angle-left fa-fw"></i>sAMAccountName spoofing完整分析</a>
<a href=/cve-2022-22947%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%88%86%E6%9E%90/ class=next rel=next title=CVE-2022-22947漏洞复现及分析>CVE-2022-22947漏洞复现及分析<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>dre4merp is trying harder.</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/dre4merp target=_blank rel="noopener noreferrer">dre4merp</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div id=cookieconsent-container></div><div class=assets><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/js/cookieconsent.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KDR7NTQEPH",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-KDR7NTQEPH" async></script></div></body></html>