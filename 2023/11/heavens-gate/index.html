<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Heaven’s Gate - dre4merp's blog</title><meta name=Description content="This is dre4merp's blog."><meta property="og:title" content="Heaven’s Gate">
<meta property="og:description" content="Introduction天堂之门 (Heaven&rsquo;s Gate) 是一种专属于 Windows 操作系统的技术，其独特之处在于主要依赖于 Windows 上的 WoW64 子系统。其核心功能包括在运行于 x64 系统下的 x"><meta property="og:type" content="article"><meta property="og:url" content="http://dre4merp.github.io/2023/11/heavens-gate/"><meta property="og:image" content="http://dre4merp.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-26T22:14:06+08:00"><meta property="article:modified_time" content="2023-11-26T22:14:06+08:00"><meta property="og:site_name" content="dre4merp's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://dre4merp.github.io/logo.png"><meta name=twitter:title content="Heaven’s Gate"><meta name=twitter:description content="Introduction天堂之门 (Heaven&rsquo;s Gate) 是一种专属于 Windows 操作系统的技术，其独特之处在于主要依赖于 Windows 上的 WoW64 子系统。其核心功能包括在运行于 x64 系统下的 x"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://dre4merp.github.io/2023/11/heavens-gate/><link rel=prev href=http://dre4merp.github.io/2023/11/explorer_dump_analysis/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Heaven’s Gate","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/dre4merp.github.io\/2023\/11\/heavens-gate\/"},"genre":"posts","wordcount":3850,"url":"http:\/\/dre4merp.github.io\/2023\/11\/heavens-gate\/","datePublished":"2023-11-26T22:14:06+08:00","dateModified":"2023-11-26T22:14:06+08:00","publisher":{"@type":"Organization","name":""},"authors":[{"@type":"Person","name":"dre4merp"}],"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"dark"==="light"||"dark"==="dark"||"dark"==="black"?(setTheme("dark"),saveTheme("dark")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>归档 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于我 </a><a class=menu-item href=/index.xml>订阅 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>归档</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于我</a><a class=menu-item href=/index.xml title>订阅</a><a href=javascript:void(0); class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#wow64-exploration>WoW64 Exploration</a><ul><li><a href=#wow64>WoW64</a></li><li><a href=#api-calling-process>API Calling Process</a></li><li><a href=#runsimulatedcode>RunSimulatedCode</a></li><li><a href=#cpupreturnfromsimulatedcode>CpupReturnFromSimulatedCode</a></li><li><a href=#turbodispatchjumpaddressend>TurboDispatchJumpAddressEnd</a></li><li><a href=#wow64systemserviceex>Wow64SystemServiceEx</a></li></ul></li><li><a href=#heavens-gate-exploration>Heaven’s Gate Exploration</a><ul><li><a href=#heavens-gate-implementation>Heaven’s Gate Implementation</a></li><li><a href=#read-x64-memmory-in-wow64-process>Read x64 memmory in WoW64 process</a><ul><li><a href=#switch-to-64-bits>switch to 64 bits</a></li><li><a href=#memcpy64>memcpy64</a></li><li><a href=#switch-to-32-bits>switch to 32 bits</a></li></ul></li><li><a href=#call-x64-api-in-x86-process>Call x64 API in x86 Process</a></li><li><a href=#example>example</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Heaven’s Gate</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class="author fas fa-user-circle fa-fw"></span><span class=screen-reader-text> </span><a href=http://dre4merp.github.io/authors/dre4merp>dre4merp</a></span></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-11-26>2023-11-26</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-11-26>2023-11-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3850 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 8 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#wow64-exploration>WoW64 Exploration</a><ul><li><a href=#wow64>WoW64</a></li><li><a href=#api-calling-process>API Calling Process</a></li><li><a href=#runsimulatedcode>RunSimulatedCode</a></li><li><a href=#cpupreturnfromsimulatedcode>CpupReturnFromSimulatedCode</a></li><li><a href=#turbodispatchjumpaddressend>TurboDispatchJumpAddressEnd</a></li><li><a href=#wow64systemserviceex>Wow64SystemServiceEx</a></li></ul></li><li><a href=#heavens-gate-exploration>Heaven’s Gate Exploration</a><ul><li><a href=#heavens-gate-implementation>Heaven’s Gate Implementation</a></li><li><a href=#read-x64-memmory-in-wow64-process>Read x64 memmory in WoW64 process</a><ul><li><a href=#switch-to-64-bits>switch to 64 bits</a></li><li><a href=#memcpy64>memcpy64</a></li><li><a href=#switch-to-32-bits>switch to 32 bits</a></li></ul></li><li><a href=#call-x64-api-in-x86-process>Call x64 API in x86 Process</a></li><li><a href=#example>example</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><h2 id=introduction class=headerLink><a href=#introduction class=header-mark></a>Introduction</h2><p>天堂之门 (Heaven&rsquo;s Gate) 是一种专属于 Windows 操作系统的技术，其独特之处在于主要依赖于 Windows 上的 WoW64 子系统。其核心功能包括在运行于 x64 系统下的 x86（WoW64）进程中直接执行 64 位代码，以及直接调用 64 位 Windows API 函数。</p><p>从正面角度来看，天堂之门可被视为一项软件保护技术。该技术的应用导致无法直接利用 IDA 等工具进行逆向分析，同时也支持跨位数的进程注入和 Hook 操作。然而，从恶意使用的角度考虑，这项技术也具有潜在风险，因为它能够隐藏对 Windows API 的调用，从而绕过一些应用层的检测机制。</p><h2 id=wow64-exploration class=headerLink><a href=#wow64-exploration class=header-mark></a>WoW64 Exploration</h2><h3 id=wow64 class=headerLink><a href=#wow64 class=header-mark></a>WoW64</h3><p>WoW64（Windows 32-bit on Windows 64-bit）是 Windows 中的一个子系统，其保证了在 x64 系统上运行 x86 程序的兼容性需求。</p><p>根据微软提供的 <a href=https://learn.microsoft.com/en-us/windows/win32/winprog64/wow64-implementation-details target=_blank rel="noopener noreferrer">WOW64 Implementation Details</a>，WoW64 子系统主要有以下 3 部分组成 (主要讨论 x64 系统)：</p><ul><li>Wow64.dll: <code>Nt*</code> 系统调用的翻译 (<code>ntoskrnl.exe</code>/<code>ntdll.dll</code>)</li><li>Wow64Win.dll: 为 <code>NtGdi*</code>、<code>NtUser*</code> 和其他 GUI 相关系统调用的翻译 (<code>win32k.sys</code>/<code>win32u.dll</code>)</li><li>Wow64Cpu.dll: 支持在 x64 上运行 x86 程序</li></ul><p>除了 <code>Nt*</code> 系统调用转换之外， <code>wow64.dll</code> 还提供核心仿真基础设施。</p><h3 id=api-calling-process class=headerLink><a href=#api-calling-process class=header-mark></a>API Calling Process</h3><p>下图展示了 x64 Windows API 的调用流程。可以观察到，它简单地将 <code>NtOpenFile</code> 的 Service Index 放入 <code>eax</code> 寄存器中，通过 <code>KUSER_SHARED_DATA</code> 中的 <code>SystemCall</code> 判断使用何种系统中断方式，然后触发系统中断进入内核。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125220607.png title="x64 Windows API 调用流程" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125220607.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125220607.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125220607.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125220607.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125220607.png 2x" sizes=auto alt="x64 Windows API 调用流程"></a></figure></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>0:007&gt; dt _KUSER_SHARED_DATA SystemCall 7FFE0000
</span></span><span class=line><span class=cl>combase!_KUSER_SHARED_DATA
</span></span><span class=line><span class=cl>   +0x308 SystemCall : 0
</span></span></code></pre></td></tr></table></div></div><p>在 WOW64 进程中，对于 <code>NtOpenFile</code> 的调用过程也类似。首先，同样将 Service Index 放入 <code>eax</code> 寄存器中，之后调用 <code>ntdll!Wow64SystemServiceCall</code> 函数。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221312.png title="WOW64 NtOpenFile 调用过程" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221312.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221312.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221312.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221312.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221312.png 2x" sizes=auto alt="WOW64 NtOpenFile 调用过程"></a></figure></p><p><code>ntdll!Wow64SystemServiceCall</code> 函数实际上只是通过一条 <code>jmp</code> 指令跳转到 <code>wow64cpu！Wow64Transition</code> 函数。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221338.png title="Wow64SystemServiceCall 跳转" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221338.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221338.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221338.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221338.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221338.png 2x" sizes=auto alt="Wow64SystemServiceCall 跳转"></a></figure></p><p>下面是实际的 <code>wow64cpu！Wow64Transition</code> 函数的内容。关于为什么不使用 Windbg 的截图，是因为由于 CPU 的模式在这几条指令中会发生改变，导致无法正常解析出完全正确的汇编代码。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221437.png title="Wow64Transition 内容" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221437.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221437.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221437.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221437.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125221437.png 2x" sizes=auto alt="Wow64Transition 内容"></a></figure></p><p><code>jmp 33:wow64cpu+6009</code> 这句汇编使用的是 opcode 为 EA 的 far jmp，与我们通常见到的基于偏移的 jmp 指令（E9）有些不同。这个指令是一种长跳转，EA 后面跟随的第一个操作数是绝对地址。成功执行后，段寄存器 cs 将被写入第二个操作数，在这个例子中为 0x33。</p><p>cs 的不同值会影响 Intel 使用不同指令集进行解析：</p><ul><li>0x23 - 当前状态是 WOW64 架构中的 32 位 Thread 模式</li><li>0x33 - 当前状态是原生 64 位 Thread 状态（运行在原生 64 位系统中）</li><li>0x1B - 当前状态是原生 32 位 Thread 状态（运行在原生 32 位系统中）</li></ul><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125223954.png title="Far jump intel" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125223954.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125223954.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125223954.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125223954.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231125223954.png 2x" sizes=auto alt="Far jump intel"></a></figure></p><p>随后，CPU 识别到 cs 为 0x33，之后的代码都会以 x64 的模式运行，因此才会出现 <strong>r15</strong> 寄存器和 qword 的关键字。</p><h3 id=runsimulatedcode class=headerLink><a href=#runsimulatedcode class=header-mark></a>RunSimulatedCode</h3><p>为了理解遇到的第一条 x64 指令中 <strong>r15</strong> 具体是什么，我们需要理解 WoW64 子系统是如何初始化自身的。具体的细节可以参考 <a href=https://wbenny.github.io/2018/11/04/WoW64-internals.html target=_blank rel="noopener noreferrer">WoW64 internals - mindless-area</a>。WoW64 进程其实也是运行在一个 x64 进程下，初始化进程后通过执行 <code>BTCpuSimulate</code> 模拟 x86 模式，执行 x86 的代码。</p><p>而 <code>BTCpuSimulate</code> 实际上是一个大的 while 循环，循环执行 x86 代码，当需要调用 API 函数 (系统中断) 时，由于系统只支持 x64 的函数，就需要切换回 x64 模式并再执行后返回。从 IDA 和 XP leak code 我们都可以清楚的看出这个逻辑。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164240.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164240.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164240.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164240.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164240.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164240.png 2x" sizes=auto alt=image.png></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164639.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164639.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164639.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164639.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164639.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126164639.png 2x" sizes=auto alt=image.png></a></figure></p><p>下面是 <code>BTCpuSimulate</code> 中 <code>RunSimulatedCode</code> 函数入口点的代码片段，执行的重点操作如下：</p><ol><li>通过 gs:30 将当前进程的 64 位 TEB 结构保存在 r12 寄存器中</li><li>将 <code>wow64cpu.dll</code> 上的一个函数列表 <code>TurboThunkDispatch</code> 保存在 <strong>r15</strong> 中</li><li>从 TEB+1488h 中提取出来 <a href=https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-context target=_blank rel="noopener noreferrer">x86 Thread Context 结构</a>，并将其保存在 r13 中，这个结构是为了保存 x86 线程的状态</li></ol><p>分析到现在我们就得到了上面关注的 r15 寄存器的值。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126162403.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126162403.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126162403.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126162403.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126162403.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126162403.png 2x" sizes=auto alt=image.png></a></figure></p><p>分析 <code>TurboThunkDispatch</code> 列表，只有两个函数需要注意:</p><ol><li><code>CpupReturnFromSimulatedCode</code> 是 32 位程序切换回 64 位环境的第一个 64 位入口函数。当 32 位程序执行需要进行系统中断的 32 位系统函数时，它会进入 <code>wow64cpu.dll</code> 导出的这个函数。在这个函数中，当前 32 位线程的状态被备份，并跳转到 <code>TurboDispatchJumpAddressEnd</code>，以便模拟当前接收到的系统中断，并执行 64 位 <code>ntdll</code> 函数。</li><li><code>TurboDispatchJumpAddressEnd</code> 的作用是调用 <code>wow64.dll</code> 导出的翻译机函数 <code>Wow64SystemServiceEx</code>，以完成对系统中断的仿真。在仿真完成后，它会从之前备份的线程状态中进行恢复，并跳回到上一次 32 位程序的返回地址，继续程序的正常执行。</li></ol><p>指令 <code>jmp [r15 + 0xF8]</code> 相当于 C 代码 <code>jmp TurboThunkDispatch[0xF8 / sizeof(uint64_t)]</code>。查看此索引处的函数指针，我们可以看到我们位于函数 <code>wow64cpu!CpupReturnFromSimulatedCode</code>。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126165029.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126165029.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126165029.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126165029.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126165029.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126165029.png 2x" sizes=auto alt=image.png></a></figure></p><h3 id=cpupreturnfromsimulatedcode class=headerLink><a href=#cpupreturnfromsimulatedcode class=header-mark></a>CpupReturnFromSimulatedCode</h3><p>显而易见的，在整个 WoW64 进程的执行过程中，一个线程至少会涉及到两个堆栈：</p><ul><li>32 位堆栈: 用于保存 32 位参数，主要用于 32 位程序的 push/pop/call/ret 等操作。</li><li>64 位堆栈: 另一个堆栈仅在 WOW64 翻译阶段使用，仅在线程切回 64 位时才会涉及。将这两个堆栈分开有许多好处，例如避免相互污染，防止参数内文或内存分配/释放大小的错误导致程序直接崩溃。</li></ul><p>下图中的 <code>xchg rsp, r14</code> 将当前使用的 32 位堆栈从寄存器 <code>esp</code> 切换到寄存器 <code>r14</code>，将 64 位堆栈从 <code>r14</code> 取回并放入 <code>rsp</code> 中，作为当前的主要堆栈，完成了两个堆栈之间的无污染切换。</p><p><code>r14</code> 中现在保存的是 32 位堆栈。因此，<code>mov r8d, [r14]</code> 取得 32 位应返回的地址 (call 时 push 的 eip)，接着将此地址保存到 <code>r13</code> 所指向的 Thread 快照纪录的 <code>CONTEXT.EIP</code> 中，以便后续跳回 32 位原始程序并继续执行。同理，<code>r11</code> 从 <code>r14+4</code> 处获取地址，即 32 位堆栈上保存当前系统函数参数的地址 (push a1 ,push a2 &mldr;)。</p><p>接下来，将 32 位运行所必需的几个关键参数（如可能受到文本操作系列指令影响的寄存器 <code>edi</code>、<code>esi</code>，与栈帧相关的 <code>ebp</code>，运算旗标记录 <code>r8d</code> 等）一并写入 <code>r13</code> 指向的 Thread 快照纪录。这样就完成了对 32 位状态的快照备份，可以安心跳转到 <code>TurboDispatchJumpAddressStart</code> 函数中进行下一步操作。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126172712.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126172712.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126172712.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126172712.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126172712.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126172712.png 2x" sizes=auto alt=image.png></a></figure></p><p>而 <code>TurboDispatchJumpAddressStart</code> 只是针对不同的 API 进行分发而已。eax 中保存的是 API 的 Service Index，计算方式是将 index 右移 16 位。所以其实 API 的 index 中高两位就是其在 TurboThunkDispatch 中的索引，而大部分的 API 的高两位都是 0，所以大部分都会执行 <code>TurboDispatchJumpAddressEnd</code>.</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126173807.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126173807.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126173807.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126173807.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126173807.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126173807.png 2x" sizes=auto alt=image.png></a></figure></p><h3 id=turbodispatchjumpaddressend class=headerLink><a href=#turbodispatchjumpaddressend class=header-mark></a>TurboDispatchJumpAddressEnd</h3><p><code>TurboDispatchJumpAddressEnd</code> 调用 <code>Wow64SystemServiceEx</code>,一次传入 API 的 index 和参数，调用完成后将结果保存在 r13 的 context 中。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174306.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174306.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174306.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174306.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174306.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174306.png 2x" sizes=auto alt=image.png></a></figure></p><p>之后便是复原刚才保存的各个寄存器的内容，最后通过 jmp far 切换回 x86 模式并继续执行。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174319.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174319.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174319.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174319.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174319.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126174319.png 2x" sizes=auto alt=image.png></a></figure></p><h3 id=wow64systemserviceex class=headerLink><a href=#wow64systemserviceex class=header-mark></a>Wow64SystemServiceEx</h3><p>上面说过，该函数的第一参数是 API 的 index，而这个 index 其实是一个 <code>WOW64_SYSTEM_SERVICE</code> 结构，其大小为 16 位。其中低 12 位表示函数识别码，而较高的 4 位表示系统函数表的辨识码。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126175257.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126175257.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126175257.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126175257.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126175257.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126175257.png 2x" sizes=auto alt=image.png></a></figure></p><p>这是个二维数组，其位于 <code>wow64.dll</code> 中，其中保存的是 wh 开头的 Nt 函数。执行 Nt 函数时，会调用对应的 whNt 函数，由其来调用对应的 64 位 Nt 函数。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180617.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180617.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180617.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180617.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180617.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180617.png 2x" sizes=auto alt=image.png></a></figure></p><p>而 <code>Wow64SystemServiceEx</code> 的作用就是利用传入的 API index 进行分发。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222109.png title="aaaddress1&amp;rsquo;s fake code" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222109.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222109.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222109.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222109.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222109.png 2x" sizes=auto alt="aaaddress1&amp;rsquo;s fake code"></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180815.png title="XP leaked Wow64SystemService" data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180815.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180815.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180815.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180815.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126180815.png 2x" sizes=auto alt="XP leaked Wow64SystemService"></a></figure></p><p>以上，便是对于 WoW64 实现原理的分析，之后我们来进入关于 Heaven’s Gate 的分析。</p><h2 id=heavens-gate-exploration class=headerLink><a href=#heavens-gate-exploration class=header-mark></a>Heaven’s Gate Exploration</h2><p>现在我们已经清楚了 WoW64 进程的工作流程。在正常情况下，其调用应如下图一样。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222720.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222720.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222720.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222720.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222720.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126222720.png 2x" sizes=auto alt=image.png></a></figure></p><p>而某些安全软件的主动防御等监控功能会 Hook 掉一些恶意软件常用的 API 函数。Hook 后的流程如下图一样。而天堂之门技术的核心就是绕过 WoW64 子系统，直接在 WoW64 进程内调用 API 函数，这样就可以 ByPass 掉一些安全软件的防护措施。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126223113.png title=image.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126223113.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126223113.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126223113.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126223113.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/20231126223113.png 2x" sizes=auto alt=image.png></a></figure></p><p>而 WoW64 进程中直接调用 x64 的 API 函数也存在两种不同的方式：</p><ol><li>搜索目标 API 函数地址，构造参数，直接调用</li><li>搜索 <code>Wow64SystemServiceEx</code> 函数的地址，通过其进行调用</li></ol><p>显然，第二种方法是通过 WoW64 子系统进行的调用，鉴于其为 Windows 自身的子系统，可以确保调用的兼容性，所以本文采用第二种方法实现。</p><h3 id=heavens-gate-implementation class=headerLink><a href=#heavens-gate-implementation class=header-mark></a>Heaven’s Gate Implementation</h3><p>天堂之门技术需要一些操作来绕过 WoW64 机制，手动切换到 64 位模式并调用 64 位下的 API 函数，大致流程如下 (<a href="https://speakerdeck.com/aaaddress1/rebuild-the-heavens-gate-from-32-bit-hell-back-to-heaven-wonderland?slide=34" target=_blank rel="noopener noreferrer">参考</a>)：</p><ol><li>通过设置 cs 标志切换到 64 位 CPU 模式</li><li>通过 (GS:0x30)->PEB 获取 PEB64</li><li>通过 PEB->Ldr 枚举加载的 64 位模块</li><li>找到 WoW64.dll 的 imageBase</li><li>获取导出的 API wow64!Wow64SystemServiceEx</li><li>传递 32 位 va_start 并执行它以将我们的 32 位模拟为 64 位中断</li></ol><h3 id=read-x64-memmory-in-wow64-process class=headerLink><a href=#read-x64-memmory-in-wow64-process class=header-mark></a>Read x64 memmory in WoW64 process</h3><p>上述流程中存在一个需要注意的问题，我们需要获取的 <code>wow64.dll</code> 的 imageBase 并在其中搜索导出函数 <code>Wow64SystemServiceEx</code>,但这个模块本身是 64 位的版本，其中的地址也是 64 位地址。而 32 位进程正常情况下，由于地址空间的问题，是无法读取 64 位进程的内存的。解决这个问题的办法就是将进程切换到 64 位模式，将内存复制到 32 位进程中，再正常进行读取。</p><h4 id=switch-to-64-bits class=headerLink><a href=#switch-to-64-bits class=header-mark></a>switch to 64 bits</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>push</span>   <span class=mi>0x33</span>                 <span class=c1>// 0x6A,0x33
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>call</span>   <span class=no>$</span><span class=err>+</span><span class=mi>5</span>                  <span class=c1>// 0xe8,0x00,0x00,0x00
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>add</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>esp</span><span class=p>],</span><span class=mi>0x5</span>  <span class=c1>// 0x83,0x04,0x24,0x05
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>retf</span>                        <span class=c1>// 0xcb
</span></span></span><span class=line><span class=cl><span class=c1>// x64 code
</span></span></span></code></pre></td></tr></table></div></div><ol><li>push 0x33，将要赋给 cs 寄存器的值压入栈</li><li>通过 call 将下一条语句的地址压入栈</li><li>将上条语句压入的地址加 5 (当前语句和下条语句的长度，修改后指向 x64 code)</li><li>retf 会将 cs 设置为 0x33(x64 模式)，并返回到栈中保存的地址</li></ol><h4 id=memcpy64 class=headerLink><a href=#memcpy64 class=header-mark></a>memcpy64</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>mov</span>    <span class=no>rdi</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>0x4</span><span class=p>]</span>                   <span class=err>&#34;\</span><span class=no>x67</span><span class=err>\</span><span class=no>x48</span><span class=err>\</span><span class=no>x8b</span><span class=err>\</span><span class=no>x7c</span><span class=err>\</span><span class=no>x24</span><span class=err>\</span><span class=no>x04</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span>    <span class=no>rsi</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>0xc</span><span class=p>]</span>                   <span class=err>&#34;\</span><span class=no>x67</span><span class=err>\</span><span class=no>x48</span><span class=err>\</span><span class=no>x8b</span><span class=err>\</span><span class=no>x74</span><span class=err>\</span><span class=no>x24</span><span class=err>\</span><span class=no>x0c</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl><span class=nf>mov</span>    <span class=no>rcx</span><span class=p>,</span><span class=no>QWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>esp</span><span class=err>+</span><span class=mi>0x14</span><span class=p>]</span>                  <span class=err>&#34;\</span><span class=no>x67</span><span class=err>\</span><span class=no>x48</span><span class=err>\</span><span class=no>x8b</span><span class=err>\</span><span class=no>x4c</span><span class=err>\</span><span class=no>x24</span><span class=err>\</span><span class=no>x14</span><span class=err>&#34;</span>
</span></span><span class=line><span class=cl><span class=na>rep</span> <span class=nf>movs</span> <span class=no>BYTE</span> <span class=no>PTR</span> <span class=no>es</span><span class=p>:[</span><span class=no>rdi</span><span class=p>],</span><span class=no>BYTE</span> <span class=no>PTR</span> <span class=no>ds</span><span class=p>:[</span><span class=no>rsi</span><span class=p>]</span>     <span class=err>&#34;\</span><span class=no>xf3</span><span class=err>\</span><span class=no>xa4</span><span class=err>&#34;</span>                
</span></span></code></pre></td></tr></table></div></div><p>通过 rep movs 命令实现 memcpy</p><h4 id=switch-to-32-bits class=headerLink><a href=#switch-to-32-bits class=header-mark></a>switch to 32 bits</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl> <span class=nf>call</span>   <span class=no>$</span><span class=err>+</span><span class=mi>5</span>                         <span class=err>&#34;\</span><span class=no>xe8</span><span class=err>\</span><span class=no>x00</span><span class=err>\</span><span class=no>x00</span><span class=err>\</span><span class=no>x00</span><span class=err>\</span><span class=no>x00</span><span class=err>&#34;</span>              
</span></span><span class=line><span class=cl> <span class=no>mov</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=err>+</span><span class=mi>0x4</span><span class=p>],</span><span class=mi>0x23</span>    <span class=err>&#34;\</span><span class=no>xc7</span><span class=err>\</span><span class=no>x44</span><span class=err>\</span><span class=no>x24</span><span class=err>\</span><span class=no>x04</span><span class=err>\</span><span class=no>x23</span><span class=err>\</span><span class=no>x00</span><span class=err>\</span><span class=no>x00</span><span class=err>\</span><span class=no>x00</span><span class=err>&#34;</span>  
</span></span><span class=line><span class=cl> <span class=no>add</span>    <span class=no>DWORD</span> <span class=no>PTR</span> <span class=p>[</span><span class=no>rsp</span><span class=p>],</span><span class=mi>0xd</span>         <span class=err>&#34;\</span><span class=no>x83</span><span class=err>\</span><span class=no>x04</span><span class=err>\</span><span class=no>x24</span><span class=err>\</span><span class=no>x0d</span><span class=err>&#34;</span>            
</span></span><span class=line><span class=cl> <span class=no>retf</span>                               <span class=err>&#34;\</span><span class=no>xcb</span><span class=err>&#34;</span> 
</span></span><span class=line><span class=cl><span class=c1>// x64 code
</span></span></span></code></pre></td></tr></table></div></div><ol><li>通过 call 将下一条语句的地址压入栈</li><li>将要赋给 cs 寄存器的值放入栈</li><li>将 call 压入的地址加 d (当前语句和下条语句的长度，修改后指向 x64 code)</li><li>retf 会将 cs 设置为 0x23(x86 模式)，并返回到栈中保存的地址</li></ol><h3 id=call-x64-api-in-x86-process class=headerLink><a href=#call-x64-api-in-x86-process class=header-mark></a>Call x64 API in x86 Process</h3><ol><li>通过 <code>memcpy64</code> 读取 64 位内存，并获取 API 地址</li><li>通过 <code>memcpy64</code> 读取 64 位内存，并获取 <code>Wow64SystemServiceEx</code> 地址</li><li>调用 API 函数时，将 API 地址写入 eax，将 translator 的地址写入 <code>0xdeadbeef</code> 所在位置</li><li>实现通过 translator 调用 x64 函数</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>int</span> <span class=nf>X64Call</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span><span class=o>*</span> <span class=n>NtApiName</span><span class=p>,</span> <span class=p>...)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>PCHAR</span> <span class=n>jit_stub</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>PCHAR</span> <span class=n>api_addr</span> <span class=o>=</span> <span class=n>PCHAR</span><span class=p>(</span><span class=n>GetApiAddress</span><span class=p>(</span><span class=n>NtApiName</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=kt>uint64_t</span> <span class=n>translator</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>translator</span><span class=p>)</span> <span class=n>GetWow64SystemServiceEx</span><span class=p>(</span><span class=n>translator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>static</span> <span class=kt>uint8_t</span> <span class=n>stub_template</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* overwirte by API address*/</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xB8</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>                   <span class=cm>/* mov    eax,0x0                  */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x8b</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span>                         <span class=cm>/* mov    edx,DWORD PTR [esp+0x4]  */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x89</span><span class=p>,</span> <span class=mh>0xC1</span><span class=p>,</span>                                     <span class=cm>/* mov    ecx,eax                  */</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* enter 64 bit mode */</span>                         
</span></span><span class=line><span class=cl>      <span class=mh>0x6A</span><span class=p>,</span> <span class=mh>0x33</span><span class=p>,</span>                                     <span class=cm>/* push   0x33                     */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xE8</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>                   <span class=cm>/* call   $+5                      */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span>                         <span class=cm>/* add    DWORD PTR [esp],0x5      */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xCB</span><span class=p>,</span>                                           <span class=cm>/* retf                            */</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* call API*/</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0xE6</span><span class=p>,</span>                               <span class=cm>/* xchg   r14,rsp                  */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xFF</span><span class=p>,</span> <span class=mh>0x14</span><span class=p>,</span> <span class=mh>0x25</span><span class=p>,</span> <span class=mh>0xEF</span><span class=p>,</span> <span class=mh>0xBE</span><span class=p>,</span> <span class=mh>0xAD</span><span class=p>,</span> <span class=mh>0xDE</span><span class=p>,</span>       <span class=cm>/* call   QWORD PTR ds:0xdeadbeef  */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x87</span><span class=p>,</span> <span class=mh>0xE6</span><span class=p>,</span>                               <span class=cm>/* xchg   r14,rsp                  */</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* exit 64 bit mode */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xE8</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>                   <span class=cm>/* call   $+5                      */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xC7</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=cm>/* mov    DWORD PTR [rsp+0x4],0x23 */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x83</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x0D</span><span class=p>,</span>                         <span class=cm>/* add    DWORD PTR [rsp],0xd      */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xCB</span><span class=p>,</span>                                           <span class=cm>/* retf                            */</span>
</span></span><span class=line><span class=cl>      <span class=mh>0xc3</span><span class=p>,</span>                                           <span class=cm>/* ret                             */</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=n>jit_stub</span> <span class=o>=</span> <span class=p>(</span><span class=n>PCHAR</span><span class=p>)</span><span class=n>VirtualAlloc</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>stub_template</span><span class=p>),</span> <span class=n>MEM_COMMIT</span><span class=p>,</span> <span class=n>PAGE_EXECUTE_READWRITE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>memcpy</span><span class=p>(</span><span class=n>jit_stub</span><span class=p>,</span> <span class=n>stub_template</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>stub_template</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>va_list</span> <span class=n>args</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>va_start</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>NtApiName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>((</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>jit_stub</span><span class=p>[</span><span class=mh>0x01</span><span class=p>])</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>api_addr</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=p>((</span><span class=kt>uint32_t</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>jit_stub</span><span class=p>[</span><span class=mh>0x1d</span><span class=p>])</span> <span class=o>=</span> <span class=p>(</span><span class=n>size_t</span><span class=p>)</span><span class=o>&amp;</span><span class=n>translator</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>auto</span> <span class=n>ret</span> <span class=o>=</span> <span class=p>((</span><span class=n>NTSTATUS</span><span class=p>(</span><span class=kr>__cdecl</span><span class=o>*</span><span class=p>)(...))</span><span class=n>jit_stub</span><span class=p>)(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=example class=headerLink><a href=#example class=header-mark></a>example</h3><p>参考 aaaddress1 的实现，通过 Heaven’s Gate 技术，利用 Process Hollowing 技术，实现了进程注入。</p><p>完整代码见 GitHub 仓库：<a href=https://github.com/dre4merp/HeavenGate target=_blank rel="noopener noreferrer">dre4merp/HeavenGate</a></p><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://wbenny.github.io/2018/11/04/WoW64-internals.html target=_blank rel="noopener noreferrer">WoW64 internals - mindless-area</a></li><li><a href="http://blog.rewolf.pl/blog/?p=102" target=_blank rel="noopener noreferrer">Mixing x86 with x64 code – ReWolf&rsquo;s blog</a></li><li><a href=https://rce.co/knockin-on-heavens-gate-dynamic-processor-mode-switching/ target=_blank rel="noopener noreferrer">Knockin’ on Heaven’s Gate – Dynamic Processor Mode Switching | RCE.co</a></li><li><a href=https://www.mandiant.com/resources/blog/WoW64-subsystem-internals-and-hooking-techniques target=_blank rel="noopener noreferrer">WoW64!Hooks: WoW64 Subsystem Internals and Hooking Techniques | Mandiant</a></li><li><a href=https://blog.30cm.tw/2021/06/32-WoW64.html target=_blank rel="noopener noreferrer">重建天堂之門：從 32 位元地獄一路打回天堂聖地（上）深度逆向工程 WoW64 設計</a></li><li><a href=https://blog.30cm.tw/2021/06/32-x96-shellcode.html target=_blank rel="noopener noreferrer">重建天堂之門：從 32 位元地獄一路打回天堂聖地（下）攻擊篇：x96 Shellcode、天堂聖杯 ＆ 天堂注入器</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-11-26</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2023/11/heavens-gate/index.txt target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate"><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer=facebook data-url=http://dre4merp.github.io/2023/11/heavens-gate/><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate" data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="分享到 Line" data-sharer=line data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate"><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="分享到 微博" data-sharer=weibo data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate"><span class="fab fa-weibo fa-fw"></span></button><button title="分享到 Myspace" data-sharer=myspace data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate" data-description><span data-svg-src=/lib/simple-icons/icons/myspace.min.svg></span></button><button title="分享到 Blogger" data-sharer=blogger data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate" data-description><span class="fab fa-blogger fa-fw"></span></button><button title="分享到 Evernote" data-sharer=evernote data-url=http://dre4merp.github.io/2023/11/heavens-gate/ data-title="Heaven’s Gate"><span class="fab fa-evernote fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2023/11/explorer_dump_analysis/ class=prev rel=prev title=Explorer_dump_analysis><i class="fas fa-angle-left fa-fw"></i>Explorer_dump_analysis</a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>dre4merp is trying harder.</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/dre4merp target=_blank rel="noopener noreferrer">dre4merp</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div id=cookieconsent-container></div><div class=assets><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/js/cookieconsent.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KDR7NTQEPH",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-KDR7NTQEPH" async></script></div></body></html>