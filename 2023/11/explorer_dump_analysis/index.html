<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Explorer_dump_analysis - dre4merp's blog</title><meta name=Description content="This is dre4merp's blog."><meta property="og:title" content="Explorer_dump_analysis">
<meta property="og:description" content="背景最近在工作中遇到了个桌面卡死问题，需要分析 dump 查找问题原因。第一次分析 dump 查找卡死问题，特此记录下。 流程 查看 explorer因为卡死的外在表"><meta property="og:type" content="article"><meta property="og:url" content="http://dre4merp.github.io/2023/11/explorer_dump_analysis/"><meta property="og:image" content="http://dre4merp.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-14T23:51:17+08:00"><meta property="article:modified_time" content="2023-11-14T23:51:17+08:00"><meta property="og:site_name" content="dre4merp's blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://dre4merp.github.io/logo.png"><meta name=twitter:title content="Explorer_dump_analysis"><meta name=twitter:description content="背景最近在工作中遇到了个桌面卡死问题，需要分析 dump 查找问题原因。第一次分析 dump 查找卡死问题，特此记录下。 流程 查看 explorer因为卡死的外在表"><meta name=application-name content="DoIt"><meta name=apple-mobile-web-app-title content="DoIt"><meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=http://dre4merp.github.io/2023/11/explorer_dump_analysis/><link rel=prev href=http://dre4merp.github.io/2022/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-windows-%E5%A0%86%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6/><link rel=next href=http://dre4merp.github.io/2023/11/heavens-gate/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Explorer_dump_analysis","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/dre4merp.github.io\/2023\/11\/explorer_dump_analysis\/"},"genre":"posts","wordcount":1143,"url":"http:\/\/dre4merp.github.io\/2023\/11\/explorer_dump_analysis\/","datePublished":"2023-11-14T23:51:17+08:00","dateModified":"2023-11-14T23:51:17+08:00","publisher":{"@type":"Organization","name":""},"authors":[{"@type":"Person","name":"dre4merp"}],"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"dark"==="light"||"dark"==="dark"||"dark"==="black"?(setTheme("dark"),saveTheme("dark")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>归档 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于我 </a><a class=menu-item href=/index.xml>订阅 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i>
</span></span><a href=javascript:void(0); class="menu-item theme-select" title=切换主题><i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-desktop title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="dre4merp's blog">dre4merp's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>归档</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于我</a><a class=menu-item href=/index.xml title>订阅</a><a href=javascript:void(0); class="menu-item theme-select" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
<select class=color-theme-select id=theme-select-mobile title=切换主题><option value=light>浅色</option><option value=dark>深色</option><option value=black>黑色</option><option value=auto>跟随系统</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#流程>流程</a><ul><li><a href=#查看-explorer>查看 explorer</a></li><li><a href=#分析-com-服务进程>分析 COM 服务进程</a></li><li><a href=#分析-rpc-消息>分析 RPC 消息</a></li></ul></li><li><a href=#结果>结果</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Explorer_dump_analysis</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class="author fas fa-user-circle fa-fw"></span><span class=screen-reader-text> </span><a href=http://dre4merp.github.io/authors/dre4merp>dre4merp</a></span></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-11-14>2023-11-14</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-11-14>2023-11-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1143 字&nbsp;<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 3 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#流程>流程</a><ul><li><a href=#查看-explorer>查看 explorer</a></li><li><a href=#分析-com-服务进程>分析 COM 服务进程</a></li><li><a href=#分析-rpc-消息>分析 RPC 消息</a></li></ul></li><li><a href=#结果>结果</a></li></ul></nav></div></div><div class=content id=content><h2 id=背景 class=headerLink><a href=#%e8%83%8c%e6%99%af class=header-mark></a>背景</h2><p>最近在工作中遇到了个桌面卡死问题，需要分析 dump 查找问题原因。第一次分析 dump 查找卡死问题，特此记录下。</p><h2 id=流程 class=headerLink><a href=#%e6%b5%81%e7%a8%8b class=header-mark></a>流程</h2><h3 id=查看-explorer class=headerLink><a href=#%e6%9f%a5%e7%9c%8b-explorer class=header-mark></a>查看 explorer</h3><p>因为卡死的外在表现就是桌面进程卡死了，所以入手点就选在 explorer 进程中。</p><blockquote><p>!process 0 0 explorer.exe</p></blockquote><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109112441.png></a></figure></p><p>发现系统存在两个 explorer.exe，其中 07ac 的 HandleCount 更多一些，明显是实际工作的进程</p><blockquote><p>.process /p /r ffffcf0f746ac080<br>!process ffffcf0f746ac080 7</p></blockquote><p>查看下所有的线程和对应的堆栈信息，需要重点关注</p><ol><li>堆栈长度，卡死的线程的堆栈都会比较深</li><li><code>Ticks</code> 表示<strong>等待的时间</strong>，卡死的线程等待时间会比较长</li><li><code>WAIT</code> 卡死问题很多都是 rpc/alpc 引起的，需要关注相关的等待类型</li><li>如果直接有 <code>Waiting for reply</code> ，这个线程也需要关注</li></ol><p>通过上述这些特征，找到了下面这个线程</p><blockquote><p>!thread ffffcf0f70d8d080</p></blockquote><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124110.png></a></figure></p><p>windbg 有针对 rpc/alpc 的扩展，可以直接查看 rpc 消息并定位到对应的 ServerThread</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124234.png></a></figure></p><h3 id=分析-com-服务进程 class=headerLink><a href=#%e5%88%86%e6%9e%90-com-%e6%9c%8d%e5%8a%a1%e8%bf%9b%e7%a8%8b class=header-mark></a>分析 COM 服务进程</h3><p>如上图，可以清晰的看到当前 rpc 请求的服务进程是 sihost.exe，服务线程是 ffffcf0f71a6a2c0，点进去看一下</p><blockquote><p>.process /p /r ffffcf0f71a72440<br>.thread ffffcf0f71a6a2c0<br>!thread ffffcf0f`71a6a2c0</p></blockquote><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124620.png></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109124726.png></a></figure></p><p>通过 KeWaitForMultipleObjects 的第一参数和第二参数可以看出其正在等待两个事件。</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109125454.png></a></figure></p><p>等待事件的原因是在发起 COM 请求，所以我们需要找到其对应的服务进程和线程来确定为什么 COM 请求被卡住了</p><p>查看 COM 请求的发起函数 <code>combase!ThreadSendReceive</code> 发现符号非常全，甚至包括其参数的类符号，看一下参数中是否有对应的 server 相关信息</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130449.png></a></figure><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109130519.png></a></figure></p><p>发现存在 pid 和 tid，那么就可以通过这两个成员获取服务进程。接下来就是找到这个参数在内存中保存的位置。因为目标机器是 x64 的，这个进程也是 x64 的进程，调用约定是 fastcall，参数的传递用的是寄存器。那么就需要查看对应代码，找到参数 rcx、rdx 在被赋值时被 push 保存到栈上的位置。</p><p>通过查看 <code>combase!ThreadSendReceive</code> 被调用时的参数赋值，可以看出目标第二参数 rdx，在赋值给 rdx 之前是由 rdi 进行保存的。而 rdi 寄存器在会被其在初始化函数时保存在栈上，由此可以找到第二参数</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131024.png></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131155.png></a></figure></p><p>下图是 <code>combase!ThreadSendReceive</code> 的栈顶位置 (rsp)</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109131343.png></a></figure></p><p>回溯堆栈就需要将函数初始化时的操作进行逆置，也就是</p><blockquote><p>000000ac`4cffa720 + 5b0 + 4 * 8</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-asm data-lang=asm><span class=line><span class=cl><span class=nf>push</span>    <span class=no>rbp</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>rsi</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>rdi</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>r12</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>r13</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>r14</span>
</span></span><span class=line><span class=cl><span class=nf>push</span>    <span class=no>r15</span>
</span></span><span class=line><span class=cl><span class=nf>lea</span>     <span class=no>rbp</span><span class=p>,</span> <span class=p>[</span><span class=no>rsp-4B0h</span><span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109132839.png></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133038.png></a></figure></p><p>至此，我们找到了 COM 的服务进程，需要继续切换进 468 进程中查看问题</p><h3 id=分析-rpc-消息 class=headerLink><a href=#%e5%88%86%e6%9e%90-rpc-%e6%b6%88%e6%81%af class=header-mark></a>分析 RPC 消息</h3><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109133135.png></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135919.png></a></figure><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109135936.png></a></figure></p><p>发现了两个正在等待 alpc reply 的线程，且 port 都属于 ffffcf0f7000d540 进程，可见是该进程内出现了卡死。重复上面 alpc 相关的分析过程，查看 message 和 ServerThread</p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140447.png></a></figure></p><p><figure><a class=lightgallery href=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png title=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png data-thumbnail=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png><img loading=lazy src=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png srcset="https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png 1.5x, https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png 2x" sizes=auto alt=https://dre4merp-cloud-images.oss-cn-beijing.aliyuncs.com/Pasted%20image%2020231109140516.png></a></figure></p><p>另一个线程是相同的堆栈，可以看出是 360FsFlt 驱动向应用层发消息时卡住了，终于就要找到问题了。接下来就是要找到这个 Filter 对应的应用层进程了。</p><blockquote><p>0: kd> x FLTMGR!FltSendMessage<br>fffff80d`9032b610 FLTMGR!FltSendMessage (void)</p></blockquote><p>根据堆栈可以看出是 360FsFlt 这个驱动对创建进程进行了监控，在创建新进程时会向应用层发消息。</p><h2 id=结果 class=headerLink><a href=#%e7%bb%93%e6%9e%9c class=header-mark></a>结果</h2><p><strong>至于具体是哪个应用层进程，其实大概可以猜出来。首先肯定是 360 的进程，最大概率就是 360Tray.exe ZhuDongFangYu.exe 360EDRSensor.exe 这些。经过分析，这个应用层进程是 360EDRSensor.exe.</strong></p><p><strong>目前还没有找到如何直接找到 FltSendMessage 应用层进程的方法，尝试通过 <code>!fltkd.fliter ffffcf0f68774010</code> 获取相关信息，但是没有找到可行的方法。之后再遇到看看有没有其他方法吧</strong></p><p><strong>至于最后应用层到底是因为什么卡死，就交给对应的同事去分析了，没有符号很难看出具体原因</strong></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-11-14</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-mardown href=/2023/11/explorer_dump_analysis/index.txt target=_blank rel="noopener noreferrer">阅读原始文档</a></span></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis><span class="fab fa-twitter fa-fw"></span></button><button title="分享到 Facebook" data-sharer=facebook data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/><span class="fab fa-facebook-square fa-fw"></span></button><button title="分享到 WhatsApp" data-sharer=whatsapp data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis data-web><span class="fab fa-whatsapp fa-fw"></span></button><button title="分享到 Line" data-sharer=line data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis><span data-svg-src=/lib/simple-icons/icons/line.min.svg></span></button><button title="分享到 微博" data-sharer=weibo data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis><span class="fab fa-weibo fa-fw"></span></button><button title="分享到 Myspace" data-sharer=myspace data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis data-description><span data-svg-src=/lib/simple-icons/icons/myspace.min.svg></span></button><button title="分享到 Blogger" data-sharer=blogger data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis data-description><span class="fab fa-blogger fa-fw"></span></button><button title="分享到 Evernote" data-sharer=evernote data-url=http://dre4merp.github.io/2023/11/explorer_dump_analysis/ data-title=Explorer_dump_analysis><span class="fab fa-evernote fa-fw"></span></button></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/2022/06/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-windows-%E5%A0%86%E7%AE%A1%E7%90%86%E6%9C%BA%E5%88%B6/ class=prev rel=prev title="深入理解 Windows 堆管理机制"><i class="fas fa-angle-left fa-fw"></i>深入理解 Windows 堆管理机制</a>
<a href=/2023/11/heavens-gate/ class=next rel=next title="Heaven’s Gate">Heaven’s Gate<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>dre4merp is trying harder.</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://github.com/dre4merp target=_blank rel="noopener noreferrer">dre4merp</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div id=cookieconsent-container></div><div class=assets><link rel=stylesheet href=/lib/lightgallery/lightgallery.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},sharerjs:!0,table:{sort:!0}}</script><script type=text/javascript src=/lib/tablesort/tablesort.min.js></script><script type=text/javascript src=/lib/lightgallery/lightgallery.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-thumbnail.min.js></script><script type=text/javascript src=/lib/lightgallery/lg-zoom.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js defer></script><script type=text/javascript src=/lib/katex/auto-render.min.js defer></script><script type=text/javascript src=/lib/katex/copy-tex.min.js defer></script><script type=text/javascript src=/lib/katex/mhchem.min.js defer></script><script type=text/javascript src=/js/katex.min.js defer></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js defer></script><script type=text/javascript src=/js/cookieconsent.min.js defer></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KDR7NTQEPH",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-KDR7NTQEPH" async></script></div></body></html>